<!-- // issPatList.html -->
{/*  总共有4处block用于子模板修改，
	name="titleSpan"，
*/}
	
<div id="divIssPatList">		

	<h4 ><span id="spTitle" class="label"></span></h4>
	
	<div class="table-responsive">
		<table class="table table-bordered table-hover">
			<thead>
				<tr>
					<th class="text-center">序号</th>
					<th class="text-center"><a data-toggle="tooltip" href="#" sortName="_TOPIC" sort="{ $sort}">专利事务标题</a></th>
					
					<th class="text-center"><a data-toggle="tooltip" href="#" sortName="_STATUS" sort="{ $sort}">状态</a></th>
					
					<th class="text-center"><a data-toggle="tooltip" href="#"  sortName="_ABSTRACT" sort="{ $sort}">状态说明</a></th>
					
					<th class="text-center"><a data-toggle="tooltip" href="#" sortName="_TIME" sort="{ $sort}">状态时间</a></th>
					
					<th class="text-center"><a data-toggle="tooltip" href="#" sortName="_PATNAME" sort="{ $sort}">专利名称</a></th>
					<th class="text-center"><a data-toggle="tooltip" href="#"  sortName="_PATTYPE" sort="{ $sort}">专利类型</a></th>
					
					<th class="text-center"><a data-toggle="tooltip" href="#" sortName="_DEPT" sort="{ $sort}">所属部门</a></th>
					
					<th class="text-center"><a data-toggle="tooltip" href="#" sortName="_WRITER" sort="{ $sort}">事务撰写人</a></th>
					
					<th class="text-center"><a data-toggle="tooltip" href="#" sortName="_EXECUTER" sort="{ $sort}">事务执行人</a></th>
					
				{in name="process" value="_INPROCESS,_DONE"}
					<th class="tpl text-center"><a data-toggle="tooltip" href="#" sortName="_PATSTATUS" sort="{ $sort}">专利状态</a></th>
				{else/}					
					<th class="tpl text-center"><a data-toggle="tooltip" href="#" sortName="_OPERATION" sort="{ $sort}">操作</a></th>
				
				{/in}

				</tr>
			</thead>
			<tbody><!-- 此处显示数据库查询后的数据集 -->
				{volist name="iss" id="vo" empty="暂时没有数据"}
				<tr>
					<td>{$i+($pageNum-1)*$listRows}</a></td>
					
					<td class="issInfo"><a href="{$home}/issue/index/issinfo/id/{$vo.id}" target="_blank" data-toggle="tooltip">{$vo.topic}</a></td>
			
					<td class="issPatStatus"><a href="{$home}/issue/index/issrecords/id/{$vo.id}" target="_blank" data-toggle="tooltip">{$vo.status}</a></td>
					
					<td><pre style="padding:0px;border:none;background-color:transparent;">{$vo.statusdescription}</pre></td>
					
					<td>{$vo.update_time}</td>
					{//应用TP5中模型的多态1对多关联得到专利事务对应的专利名称$vo.issmap.topic，关键是要在issinfo模型中定义morphTo的方法名"issmap"，就可"." 出$vo.issmap.topic}
					<td class="patInfo"><a href="{$home}/patent/index/patinfo/id/{$vo.issmap_id}" target="_blank" data-toggle="tooltip">{$vo.issmap.topic}</a></td>
					
					{//同上得到$vo.issmap.pattype}
					<td>{$vo.issmap.pattype}</td>
					
					<td>{$vo.dept}</td>
					<td>{$vo.writer}</td>
					<td>{$vo.executer}</td>
					
					{in name="process" value="_INPROCESS,_DONE"}
					<td class="patStatus">
						<a href="{$home}/patent/index/patrecords/id/{$vo.issmap_id}" target="_blank" data-toggle="tooltip">
					{switch name="vo.issmap.status"}
    					{case value="授权|续费授权|续费中"}
						<span class="label label-success">{$vo.issmap.status}</span>
						{/case}
						{case value="驳回|驳回续费"}
						<span class="label label-danger">{$vo.issmap.status}</span>
						{/case}
						{case value="放弃续费"}
						<span class="label label-warning">{$vo.issmap.status}</span>
						{/case}
						{case value="超期无效"}
						<span class="label label-default">{$vo.issmap.status}</span>
						{/case}
					
						{default /}
						<span class="label label-primary">{$vo.issmap.status}</span>
						{/switch}
						</a>
					</td>
					{else/}
					<td class="btnTpl">
						<a class="" href="#modalIssPatSingle" data-issId="{$vo.id}" data-issTopic="{$vo.topic}" data-issue-status="{$vo.status}" data-issue-authority="" data-toggle="modal" ></a>
				
					</td>
					{/in}
					
				</tr>
				{/volist}
			</tbody>
		</table>
	</div>
	
	<div id="divListRows" class="col-sm-12 text-right search">
		<!-- // 分页变量 -->
		<div class="col-sm-10 text-right">{$pageRender}</div>
						
		<div class="form-group form-group-sm col-sm-2">
			<span class="">每页记录行数：</span>
				<select class="form-control" id="listRows" data-process="{$process}">
					<option value="5">5</option>
					<option value="10">10</option>
					<option value="20">20</option>
					<option value="50">50</option>
				</select>
						
		</div>
	</div>
	
</div>

<!-- Modal "modalIssPatSingle" -->
<div class="modal fade" id="modalIssPatSingle" role="dialog">
	<div class="modal-dialog modal-lg">
    
      <!-- Modal content-->
      	<div class="modal-content">
        <div class="modal-header bg-warning" style="border-radius:5px;">
          	<button type="button" class="close" data-dismiss="modal">&times;</button>
		  
          	<h4><span class="glyphicon glyphicon-wrench">专利事务</span></h4>
        </div>
		
        <div class="modal-body">
			<!-- // 单个issPat增删改查页面显示位置，需load其他模板文件的div-->
			<div id="divIssPatSingle_load"><h4 style="margin:50px;">加载中……</h4></div>
		</div>
		
		<div class="modal-footer" hidden="true">
        	<input type="button" class="btn btn-primary btn-sm" data-dismiss="modal" value="返回">  
          
        </div>
		</div>
	</div>

</div>
<!--/ Modal "modalIssPatSingle" -->

{block name="script"}
<script>

var aHtml=function(auth){
	var aSpanClass='';
	var aText='';
	switch(auth){
		case'_EDIT':
			aSpanClass='glyphicon glyphicon-pencil text-primary';
			aText='_编辑';
		break;
		case'_AUDIT':
			aSpanClass='glyphicon glyphicon-check text-warning';
			aText='_审核';
		break;
		case'_APPROVE':
			aSpanClass='glyphicon glyphicon-ok text-danger';
			aText='_审批';
		break;
		case'_EXECUTE':
			aSpanClass='glyphicon glyphicon-random text-primary';
			aText='_执行';
		break;
		case'_MAINTAIN':
			aSpanClass='glyphicon glyphicon-calendar text-primary';
			aText='_管理/维护';
		break;
	}
	return '<span class="'+aSpanClass+'"></span>'+aText;
};

//利用自调用匿名函数立即执行的特点，设定$('#spTitle')和$('a[data-issue-process="'+process+'"]')的显示格式。
(function($){
    var process=$('#listRows').data('process');
	var obj=$('a[data-issue-process="'+process+'"]');
		
		//恢复数字显示的初始格式
		$('.num').removeClass('badge').removeClass('mycolorred-bgwhite').addClass('mycolorwhite-bgtransparent');
		//设置a所在li为“active”
		obj.closest('li').addClass('active');
		//设置a所含数字的显示格式
		obj.find('.num').addClass('badge mycolorred-bgwhite');
		
		//load的文件中根据process的不同对#spTitle添加class和text
		switch(process){
			case'_TODO':
				spClass='label-warning';
				spText='待处理';
				break;
			case'_INPROCESS':
				spClass='label-info';
				spText='流程中';
				break;
			case'_RENEW':
				spClass='label-warning';
				spText='待续费';
				break;
			case'_DONE':
				spClass='label-default';
				spText='完结';
				break;
		}
		$('#spTitle').remove('label-warning label-default label-info');
		$('#spTitle').addClass(spClass).text(spText);
	
})(jQuery);

$(document).ready(function(){	
	<!-- console.log('x:'+'{$x}'); -->
	
	<!-- console.log('y:'+'{$y}'); -->
	<!-- var str='{$x}'; -->
	<!-- var obj = JSON.parse(str); -->
	<!-- console.dir(obj.total); -->
	
	<!-- //表格每页显示记录行数 -->
	$('#listRows').val('{$listRows}');
	
	//调整span里的.label
	$('span.label').css({'padding-bottom':'2px','margin-bottom':'2px'});
	//调整span里的.badge
	$('span.badge').css({'margin-bottom':'1px'});
	
	//为指定行上色
	$('table').find('a[data-issid="{$issId}"]').closest('tr').addClass('bg-warning');

	//完善.btnTpl中的a，各个权限的操作
	$('.btnTpl a').each(function(){
		var status=$(this).data('issue-status');
		var auth='';
		if($.inArray(status,{$edit})>=0){
			auth='_EDIT';
		}
		
		if($.inArray(status,{$audit})>=0){
			auth='_AUDIT';
		}
		
		if($.inArray(status,{$approve})>=0){
			auth='_APPROVE';
		}
		
		if($.inArray(status,{$execute})>=0){
			auth='_EXECUTE';
		}
		
		if($.inArray(status,{$maintain})>=0){
			auth='_MAINTAIN';
		}
		
		$(this).data('issue-authority',auth);
		$(this).html(aHtml(auth));
		//console.dir(auth);
	
	});
		
	
	// 根据后端控制器给出的排序字段{ $sortName},排序方式{ $sort}，修改th中a的显示形式
	$('#divIssPatAuth thead a').each(function(){
	
		var glyAsc='<span class="small glyphicon glyphicon-sort-by-attributes text-muted"></span>';
		var glyDesc='<span class="small glyphicon glyphicon-sort-by-attributes-alt text-warning"></span>';
		
		//排序字段{ $sortName}已赋值在a的“sortName”属性中
		var sortName=$(this).attr('sortName');
		// 排序方式{ $sort}已赋值在a的“sort”属性中
		var sort=$(this).attr('sort');
		
		<!-- // 后端控制器给出的排序字段{ $sortName}, -->
		<!-- if (sortName=='{ $sortName}'){ -->
			<!-- if(sort=='_ASC'){ -->
				<!-- $(this).append(glyAsc); -->
				<!-- $(this).attr('sort','_DESC'); -->
				<!-- $(this).attr('data-original-title','点击后降序'); -->
				<!-- // bootstap3中修改tooltip的options属性值 -->
				//$(this).data("bs.tooltip").options.title="点击后降序";
				//$(this).data("bs.tooltip").options.placement="top";
				<!-- $(this).tooltip({placement: 'top'}); -->
			<!-- }else{ -->
				<!-- $(this).append(glyDesc); -->
				<!-- $(this).attr('sort','_ASC'); -->
				<!-- $(this).attr('data-original-title','点击后升序'); -->
				<!-- // bootstap3中修改tooltip的options属性值 -->
				//$(this).data("bs.tooltip").options.title="点击后降序";
				//$(this).data("bs.tooltip").options.placement="top";
				<!-- $(this).tooltip({placement: 'top'}); -->
			<!-- } -->
		<!-- } -->
	});	
	
	// 添加bootstrap的tooltip属性
	$('#divIssPatAuth thead th a').tooltip({title: '点击排序', placement: 'bottom'});
	
	$('.patInfo a').tooltip({title: '专利信息', placement: 'bottom'});
	$('.patStatus a').tooltip({title: '专利过程记录', placement: 'bottom'});
	
	$('.issInfo a').tooltip({title: '事务信息', placement: 'bottom'});
	$('.issPatStatus a').tooltip({title: '事务过程记录', placement: 'bottom'});
	
	// 点击th中的a，表格中的内容根据a中的属性值进行排序
	$('#divIssPatAuth thead a').click(function(){
		
		var sort=$(this).attr("sort");
		var sortName=$(this).attr("sortName");
		
		// 得到页面锚点值
		<!-- var fragment = window.location.hash;	 -->
		
		<!-- //根据每页显示记录行数，pat状态，排序字段，排序方式加载页面 -->
		<!-- loadMe($('#patIssTableRows').val(),sortName,sort); -->
		
	});
	
	// <td>里<a>标签的click事件,给标签所在行上色
	$('td a').click(function(){
		// 所有行去掉附加的bg-warning
		$('tr').removeClass('bg-warning');
		// 本<a>标签所在行上色bg-warning
		$(this).parent().parent().addClass('bg-warning');
	});
	
	<!-- //根据每页显示记录行数和issStatus加载页面 -->
	$('#listRows').change(function(){
		console.log($(this).data('process'));
		loadMe({'process':$(this).data('process'),'listRows':$(this).val()});
	
	});	
	
	<!-- // 点击后端提供分页内容后分页索引中的a，根据a中的属性值进行显示 -->
	$('#divListRows a').click(function(event){
		// a所在分页页数
		var pageStr=$(this).text();
		var pageNum;
		//(li.active)所代表的页数
		var pageNumActive=$('#divListRows li.active').children('span').text();
		
		// jQuery的preventDefault()方法阻止元素发生默认的行为。阻止访问a的URL
        event.preventDefault();
		<!-- alert("pageStr:"+pageStr+" active:"+pageNumActive); -->
		
		switch(pageStr){
			case'»':
				//用"*"确保得到的是加法运算结果，而不是字符串
				pageNum=(pageNumActive*1+1);
			break;
			
			case'«':
				pageNum=(pageNumActive*1-1);
			break;
			
			default:
				pageNum=pageStr;
			break;
		
		}
		<!-- alert("pageNum:"+pageNum); -->
		
		<!-- //根据每页显示记录行数，排序字段，排序方式，分页页数加载页面 -->
		loadMe({'process':$('#listRows').data('process'),'listRows':$('#listRows').val(),'pageNum':pageNum});
	
	});
	
	// patIss表格中<td>里<a>标签的click事件,Ajax处理数据引入#modalIssPatSingle所需内容
	$(".btnTpl a").click(function(){
		var issId=$(this).attr('data-issId');
		var topic=$(this).attr('data-issTopic');
		var auth=$(this).attr('data-issue-authority');
		var aHtml=$(this).html();
		//向后端“issPatAuthSingle”(TP5中 'issPatAuthSingle'='{$home}/dashboard/index/issPatAuthSingle' )发送数据(后端用于选择返回的模板文件)		
		$.post('issPatAuthSingle',
			{
				'issId':issId,
				'auth':auth,
				'returnType':0,
			},
			//得到后端返回的data(模板文件)
			function(data){
				//在本文件#divIssPatSingle_load处渲染显示data
				$('#divIssPatSingle_load').html(data);
				$('.modal-header').find('h4').empty().html('<span class="glyphicon glyphicon-wrench">专利事务：</span>【<strong>'+aHtml+'</strong>】《'+topic+'》');
			}
		);
		
	});
	
	// 在modalIssPatSingle出现前应用jQuery的load方法加载对应文件。
	<!-- $('#modalIssPatSingle').on('bs.show', function(){ -->
    	<!-- var sendData={"issId":}; -->
		
		<!-- $("#divIssPatSingle_load").load('divIssPatSingle_load',sendData); -->
  	<!-- }); -->

<!-- function -->
	
	//**函数名：loadMe
 	//* 作用：加载本页面内容到指定div中<div id="divIssPatList_load"></div>
	//* 参数1：rows，Int。值：可为空，每页显示的记录行数。默认为10。
	//* 参数2：sortName，String。值：可为空，排序字段名称。默认为‘_TOPIC’。
	//* 参数3：sortOrder，String。值：可为空，排序方式。默认为'_ASC'。
	//* 参数4：pageNum，Int。值：可为空，当前页数。默认为1。
	//* 参数5：process，String。值：可为空，所处进程。默认为'_TODO'。
	//* 参数6：serchWord，Array。值：可为空，查询关键词键值对。默认为空。
	
	function loadMe(options){
		var defaults={
			'listRows':10,
			'sortName':'_TOPIC',
			'sortOrder':'_ASC',
			'pageNum':1,
			'process':'_TODO',
			'serchWord':{}
		};
		var data = $.extend({},defaults, options);
		
		var process=data.process;
		
		// 本页的搜索区输入框的查询词
		<!-- var searchWord={ -->
			<!-- 'dept':$('#searchDept').val(), -->
			<!-- 'name':$('#searchPatName').val(), -->
			<!-- 'status':$('#searchPatStatus').val(), -->
			<!-- 'type':$('#searchPatType').val(), -->
			<!-- 'writer':$('#searchWriter').val() -->
		<!-- }; -->
		<!-- $.extend(settings.searchWord, searchWord); -->
		$('#divIssPatList_load').html('<h4 style="margin:50px;">加载中……</h4>');
		// jquery load()方法，本文件加载到index.html的指定区域<div id="divIssPatList_load"></div>
		$('#divIssPatList_load').load('issPatList',{'data':data});
	}

<!-- function -->
});

</script>
{/block}