<!-- // view/index.html 对应AssetController.php的index操作 -->

<div>
	<div id="divTopBtn" style="margin:10px 0px;">
		<span class="label label-info" style="font-size:16px;">固定资产总数
		</span>&nbsp;<span class="badge">{$quanCount}</span>&nbsp;
		<button id="btnSearchInfo" type="button" class="btn-link" data-toggle="tooltip" data-placement="bottom" title="显示/隐藏搜索条件"><span class="glyphicon glyphicon-collapse-down"></span><span>显示搜索</span></button>
				
		<button id="btnRefresh" type="button" class="btn-link" data-toggle="tooltip" data-placement="bottom" title="刷新固定资产信息表"><span class="glyphicon glyphicon-refresh"></span>刷新</button>
		
		<button id="btnCreate" type="button" class="btn-link" data-toggle="tooltip" data-placement="bottom" title="新增固定资产记录"><span class="glyphicon glyphicon-pencil"></span>新增</button>
		
	</div>
	
	<!-- // 搜索区域-->
	<div id="divSearchData" class="collapse">
		<div class="label label-info" style="font-size:14px;">搜索条件</div>
		<form id="fmAssSearch" style="border:1px solid #eee;padding:10px 0px 10px 0px;">
			
			<div class="row myRow">
			<div class="form-group col-sm-4">
				<label class="" for="brand_model">名称（品牌型号）</label>
				<input class="form-control" id="brand_model" name="brand_model" type="text" value="" placeholder="...不限">
										
			</div>
			<div class="form-group col-sm-2">
				<label class="" for="assnum">编号</label>
				<input class="form-control" id="assnum" name="assnum" type="text" value="" placeholder="...不限">
										
			</div>
			
			<div class="form-group col-sm-3">
				<label class="" for="code">卡号</label>
				<input class="form-control" id="code" name="code" type="text" value="" placeholder="...不限">
										
			</div>
			
			<div class="form-group col-sm-3">
				<label class="" for="bar_code">条形码号</label>
				<input class="form-control" id="bar_code" name="bar_code" type="text" value="" placeholder="...不限">
										
			</div>
			</div>
			
			<div class="row myRow">
			<div class="form-group col-sm-6">
				<label class="control-label" for="dept_now">现使用部门</label>
				<!-- <select multiple class="form-control" id="searchPatType" name="searchPatType" > -->
				<select class="form-control" id="selectDeptNow" name="dept_now" >
						<option value="">d1</option>
				</select>
			</div>
			<div class="form-group col-sm-4">
				<label class="" for="place_now">现放置地点</label>
				<select class="form-control" id="selectPlaceNow" name="place_now" >
						<option value="">p1</option>
				</select>
										
			</div>
			
			<div class="form-group col-sm-2">
				<label class="" for="keeper_now">现保管人</label>
				<select class="form-control" id="selectKeeperNow" name="keeper_now" >
						<option value="">k1</option>
				</select>
										
			</div>
			</div>			
			
			
			<div class="row myRow">
			<div class="col-sm-6">
				<button id="btnSearch" type="button" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-search"></span>搜索</button>
			
				<button id="btnSearchReset" type="button" class="btn btn-primary btn-sm">条件重置</button>
			</div>
			</div>
		
		</form>
		</br>
	</div>
	
	
	<p id="pSearchResultNum" ><strong>搜索结果</strong>:&nbsp;<span class="label label-info">{$searchResultNum}</span>条记录</p>
	
	<div id="divLoadAssList">
		<div id="divTblAssList" class="table-responsive" data-sort-name="" data-sort-order="" data-list-rows="" data-page-num=""> 
			<table class="table table-bordered table-striped table-hover table-condensed">
				<caption class="text-center" style="border-bottom:1px solid #eee;"><h4>固定资产信息表</h4></caption>
				<thead>
					<tr>
						<th class="text-center">序号</th>
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="assnum" data-sort-order="">编号</a></th>
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="code" data-sort-order="">卡号</a></th>
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#" data-sort-Name="bar_code" data-sort-order="" >条形码号</a></th>
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="brand_model" data-sort-order="">名称</a></th>
					
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="place_now" data-sort-order="">现放置地点</a></th>
					
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="quantity" data-sort-order="">数量</a></th>
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="dept_now" data-sort-order="">现使用部门</a></th>
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="keeper_now" data-sort-order="">现保管人</a></th>
					
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="status_now" data-sort-order="">状态</a></th>
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="status_now_user_name" data-sort-order="">登记人</a></th>
						<th class="text-center"><a class="" data-title="点击排序" data-toggle="tooltip" href="#"  data-sort-Name="status_now_user_name" data-sort-order="">操作</a></th>
					
					</tr>
			
				</thead>
				<tbody><!-- 此处显示数据库查询后的数据集assSet -->
					{volist name="assSet" id="vo" empty="暂时没有数据"}
					<tr>
						<td>{$i+($sortData.pageNum-1)* $sortData.listRows}</td>
						<td>{$vo.assnum}</td>
						<td>{$vo.code}</td>
						<td>{$vo.bar_code}</td>
						<td>{$vo.brand_model}</td>
						<td>{$vo.place_now}</td>
						<td>{$vo.quantity}</td>
						<td>{$vo.dept_now}</td>
						<td>{$vo.keeper_now}</td>
						<td>{$vo.status_now}</td>
						<td>{$vo.status_now_user_name}</td>
						<td>oprt</td>
				
					</tr>
					{/volist}
			
				</tbody>
			
			</table>
			
			<div id="divListRows" class="col-sm-12 text-right">
				<!-- // 分页变量 -->
				<div class="col-sm-10 text-right">{$assList}</div>
		
				<div class="form-group form-group-sm col-sm-2">
					<span class="">每页记录行数：</span>
					<select class="form-control" id="listRows">
						<option value="5">5</option>
						<option value="10">10</option>
						<option value="20">20</option>
						<option value="50">50</option>
					</select>
						
				</div>
	
			</div>
	
		</div>
		
	</div>
		

</div>
<!-- Modal "modalAssSingle" -->
<div class="modal fade" id="modalAssSingle" role="dialog">
	<div class="modal-dialog modal-lg">
    
      <!-- Modal content-->
      	<div class="modal-content">
        <div class="modal-header bg-info" style="border-radius:5px;">
          	<button type="button" class="close" data-dismiss="modal">&times;</button>
		  
          	<h4><strong>新增固定资产</strong</h4>
        </div>
		
        <div class="modal-body">
			<!-- // 单个issPat增删改查页面显示位置，需load其他模板文件的div-->
			<div id="divLoadAssSingle"><p class="text-center" style="font-size:28px;">加载中……</p></div>
		</div>
		
		<div class="modal-footer" hidden="true">
        	<input type="button" class="btn btn-primary btn-sm" data-dismiss="modal" value="返回">  
          
        </div>
		</div>
	</div>

</div>
<!--/ Modal "modalAssSingle" -->

<!-- /pagewrap  -->

<script>
//全局变量
<!-- var sortDataObj={'listRows':10,'sortName':'assnum','sortOrder':'asc','pageNum':1}; -->
var urlPrefix='{$home}/dashboard/asset/';

//**函数名：glyphiconTextChange
 	//* 作用：obj内含的glyphicon进行变换
	//* 参数1：obj，String。值：必须，要交换glyphicon的obj
	//* 参数2：iconText1，Json。值：必须，{icon:'glyphicon-xx',text:'xx'}。
	//* 参数3：iconText2，Json。值：必须，{icon:'glyphicon-yy',text:'yy'}。
	//* 无返回值
var glyphiconTextChange=(obj,iconText1,iconText2)=>{
	if(obj.find('.'+iconText2.icon).length){
	    obj.find('.glyphicon').removeClass(iconText2.icon).addClass(iconText1.icon).next('span').html(iconText1.text);
    }else{
	    obj.find('.glyphicon').removeClass(iconText1.icon).addClass(iconText2.icon).next('span').html(iconText2.text);
    }
};

//**函数名：ajaxShowSelect
 	//* 作用：本页面ajax过程向服务器请求特定单选框内容所需数据，并组装好HTML语句
	//* 参数url，类型：字符串。值：不为空。说明：ajax操作的URL。
	//* 参数sendData，类型：数值。值：传送给后端的键值对数据。
	//* 参数obj，类型：对象。值：必须，单选框的对象名称
	//*参数attach，类型：json数组。值：可为空，需要附加的单选框的键值对，[{"text":"...不限","val":"0"},{"text":"xx","val":"xx"}]
	//*参数selected，类型：字符。值：字符，可为空。
	//* 返回值：无
var ajaxShowSelect=(options)=>{
	var defaults={
		'url':urlPrefix+'selectRes',
		'attach':[{"text":"...不限","val":"0"}],
		'sendData':'',
		'obj':'',
		'selected':'',
	};
	var data = $.extend({},defaults, options);
	var arrJson=data.attach;
	var req=data.sendData.req;
	var obj=data.obj;
	var selected=data.selected;
	var str='';
	
	$.post(data.url,data.sendData,function(result){
		if(arrJson.length){
			for(i=0;i<arrJson.length;i++){
				str+='<option value="'+arrJson[i].val+'">'+arrJson[i].text+'</option>';
			}
		}
		// result数组,取出value值组装HTML语句
		$.each(result,function(n1,v1){
			str+='<option value="'+v1+'">'+v1+'</option>';	
		});
		<!--// 清空单选框Obj的所有选项-->
		obj.empty();
		<!--// 添加单选框Obj的新选项-->
		obj.append(str);
		<!-- // value=selected 的项为选定项-->
		if (selected!=''){
			obj.val(selected);
		}
	});
};

//**函数名：loadMe
 	//* 作用：加载本页面内容
	//* 参数1：listRows，Int。值：可为空，每页显示的记录行数。默认为10。
	//* 参数2：sortName，String。值：可为空，排序字段名称。默认为‘_TOPIC’。
	//* 参数3：sortOrder，String。值：可为空，排序方式。默认为'_ASC'。
	//* 参数4：pageNum，Int。值：可为空，当前页数。默认为1。
	//* 参数6：serchWord，Array。值：可为空，用户搜索关键词键值对。默认为空。
var loadMe=()=>{
	//排序有关的参数都从$('#divTblAssList')获取
	var obj=$('#divTblAssList');
	var sortData={
		'listRows':obj.data('listRows'),
		'sortName':obj.data('sortName'),
		'sortOrder':obj.data('sortOrder'),
		'pageNum':obj.data('pageNum'),
	};	
	//排序有关的参数默认值
	var sortDataDefault={'listRows':10,'sortName':'assnum','sortOrder':'asc','pageNum':1};
	sortData=$.extend({},sortDataDefault,sortData);
	console.log(sortData);
	//用户搜索有关键值对从表单$('#fmIssPatSearch')获取
	var formData=new FormData($('#fmAssSearch')[0]);
	
	var searchData={};
	//使用Map对象的forEach方法组装键值对
	formData.forEach(function(val,key,){
		//非0非空的值才进行组装
		if(val!='' && val!=0){
			searchData[key]=val;
		}
	});
	JSON.stringify(searchData);
	
	$('#divLoadAssList').html('<p class="text-center" style="font-size:20px;">加载中……</p>');
	
	//console.log('sortData:');
	//console.dir(sortData);
	
	<!-- $.post(urlPrefix+'index', -->
		<!-- {'sortData':sortData,'searchData':searchData} -->
	<!-- ); -->
	$('#divLoadAssList').load(urlPrefix+'index #divTblAssList',{'sortData':sortData,'searchData':searchData});
};

//利用自调用匿名函数立即执行的特点，设定$('#selectDeptNow')、$('#selectPlaceNow')、$('#selectKeeperNow')。
(function($,ajaxShowSelect){

	//设定$('#fmAssSearch')内的select组件的option
	$.when(
		ajaxShowSelect({sendData:{req:$('#selectDeptNow').attr('name')},obj:$('#selectDeptNow')}),
		ajaxShowSelect({sendData:{req:$('#selectPlaceNow').attr('name')},obj:$('#selectPlaceNow')}),
		ajaxShowSelect({sendData:{req:$('#selectKeeperNow').attr('name')},obj:$('#selectKeeperNow')}),
	).then(
		function(data, textStatus, jqXHR){
     		//ajax成功
			loadMe();
		},
		function(){
			//ajax失败
			$.alert('失败Group，请稍后再试！');
		}
	);
})(jQuery,ajaxShowSelect);

$(document).ready(function(){
	// 设置各类tooltip
	$('#divTopBtn [data-toggle="tooltip"]').tooltip({triger:'focus',placement: 'auto bottom'});	
	
	$('#btnSearchInfo').click(function(){
		var iconText1={icon:'glyphicon-collapse-up',text:'隐藏搜索'};
		var iconText2={icon:'glyphicon-collapse-down',text:'显示搜索'};
		//变换图标和内容
		glyphiconTextChange($(this),iconText2,iconText1);
		//显示、隐藏#divSearchData
		$('#divSearchData').collapse('toggle');
			
		$(".collapse").on('show.bs.collapse', function(){
			var obj=$('#pSearchResultNum');
			if($obj.find('.label').text()*1){
				obj.show();
			}else{
				obj.hide();
			}
    	});
		<!-- if($(this).find('.'+iconText1.icon).length && getJsonLength(searchDataArr)==0){ -->
			<!-- $('#searchTopic').focus(); -->
		<!-- } -->
	});
	
	<!-- //表格每页显示记录行数 -->
	$('#listRows').val('{$sortData.listRows}'); 
	
	$('#listRows').change(function(){
		//排序数据向$('#divTblAssList')汇集
		$('#divTblAssList').data('listRows',$(this).val());
		loadMe();
	});	
	
	//列表按选中的组件信息重新排序
	$('thead a').click(function(){
		sortData=$.extend({},sortData,{'listRows':$('#listRows').val()*1,'sortOrder':$(this).data('sortOrder'),'sortName':$(this).data('sortName')});
		//loadAssList(sortData);
		
	});	
	
	<!-- // 点击分页中的a，表格中的内容根据a中的属性值进行排序,但不改变之前选中 thead a时的排序信息-->
	$('#divListRows a').click(function(evt){
		// a所在分页页数
		var pageStr=$(this).text();
		var pageNum;
		//(li.active)所代表的页数
		var pageNumActive=$('#divListRows li.active').children('span').text();
		
		var sortName=$('thead').find('.label').data('sortName');
		var sortOrder=$('thead').find('.label').data('sortOrder');
		<!-- var sortObj=$('thead').find('.label'); -->
		
		evt.preventDefault();
		
		switch(pageStr){
			case'»':
				//用"*"确保得到的是加法运算结果，而不是字符串
				pageNum=(pageNumActive*1+1);
			break;
			
			case'«':
				pageNum=(pageNumActive*1-1);
			break;
			
			default:
				pageNum=pageStr*1;
			break;
		
		}
		
		//loadAssList({'listRows':$('#listRows').val()*1,'pageNum':pageNum,'sortName':sortName,'sortOrder':sortOrder});
		
	});
	
	<!-- // 页面刷新 -->
	$('#btnRefresh').click(function(){
		//搜索表单重置
		$('#fmAssSearch')[0].reset();
		//loadAssList();
		
	});
	
	//新增固定资产记录
	$('#btnCreate').click(function(){
	
		$("#modalAssSingle").modal();
	});
	
	
	
<!-- //表单$('#fmAssSearch')有关的代码块 -->
	
	$('#fmAssSearch .form-control').change(function(){
		//表单输入框去掉附加底色
		$(this).removeClass('label-info');
	});
	
	//表单提交，开始asset搜索
	$('#btnSearch').click(function(){
		//loadAssList();
	});
	
	//表单重置
	$('#btnSearchReset').click(function(){
		var fm=$(this).closest('form');
		fm[0].reset();
		fm.find('.form-control').removeClass('label-info');
		fm.find('.timeGroup').hide();
	});
	

});
</script>
