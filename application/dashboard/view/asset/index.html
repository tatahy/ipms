<!-- // dashboard\view\asset\index.html, 对应AssetController.php的index操作 -->

<div class="content-header">
	<h4>
		<a href="#divAssTotal" data-toggle="collapse"><span class="glyphicon glyphicon-oil"></span>固定资产管理</a>
	</h4>
	
	<div id="divAssTotal" class="collapse text-center" style="font-size:18px;padding:10px;">
		【记录总数：<span id="assNumTotal" class="label label-info">{$numTotal}</span>&nbsp;|&nbsp;数量总计：<span id="assQuanTotal" class="badge">{$quanTotal}</span>】
	</div>
	
	<ul id="ulAssType" class="nav nav-pills" style="margin-top:10px;border-bottom: 1px solid #eee;">
		<li class="active dropdown">			
			 <a class="dropdown-toggle" data-toggle="dropdown"  href="#_ASSS_USUAL">
			 	<span class="spType">概况&nbsp;</span>
				<span class="caret"></span>
			 </a>
      			<ul class="dropdown-menu">
        			<li class="active">
						<a class="aPill" href="#_ASSS_USUAL" data-ass-type="_ASSS_USUAL" data-layer="asset"><span class="spType">[总计]&nbsp;</span></a>
					</li>
					<li class="divider"></li>
					
					<li>
						<a class="aPill" href="#_ASSS1" data-ass-type="_ASSS1" data-layer="asset"><span class="spType">[待定]&nbsp;</span></a>
					</li>
				
					<li>
						<a class="aPill" href="#_ASSS2" data-ass-type="_ASSS2" data-layer="asset"><span class="spType">[正常]&nbsp;</span></a>
					</li>
					
        			<li>
						<a class="aPill" href="#_ASSS3" data-ass-type="_ASSS3" data-layer="asset"><span class="spType">[异常]&nbsp;</span></a>
					</li>
					<li>
						<a class="aPill" href="#_ASSS4" data-ass-type="_ASSS4" data-layer="asset"><span class="spType">[停用]&nbsp;</span></a>
					</li>  
					<li>
						<a class="aPill" href="#_ASSS5" data-ass-type="_ASSS5" data-layer="asset"><span class="spType">[销账]&nbsp;</span></a>
					</li>  					
      			</ul>
			
		</li>
		
		<li>
			<a class="aPill text-danger" href="#_ASSS6" data-ass-type="_ASSS6"  data-layer="asset"><span class="glyphicon glyphicon-trash"></span><span class="spType">[回收站]&nbsp;</span></a>
		</li>
	
	</ul>
</div>

<div class="content-body">
	<div id="divTopBtn" class="row myRow text-right" style="margin:10px 0px;">		
		<div class="btn-group">
			<button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown" title="选择查询方式"><span class="glyphicon glyphicon-search"></span>查询<span class="caret"></span></button>
      		<ul class="dropdown-menu" role="menu">
				<li><a id="aSearchData" href="#divSearchData" data-toggle="collapse" title="根据输入信息查询"><span class="glyphicon glyphicon-edit"></span>一般查询</a></li>
    			<li role="separator" class="divider"></li>
    			<li><a id="aSearchByBarcode" href="#divSearchByBarcode"  data-toggle="collapse" title="输入/ 拍摄条形码图片<br>识别后查询"><span class="glyphicon glyphicon-barcode"></span>条形码查询</a></li>
      		</ul>
    	</div>
				
		<button id="btnRefresh" type="button" class="btn btn-primary btn-sm" title="刷新固定资产信息表"><span class="glyphicon glyphicon-refresh"></span>刷新</button>
		
		<button class="btn btn-primary btn-sm btnAssOprt" data-ass-id="0" data-ass-oprt="_CREATE" title="新增固定资产记录"><span class="glyphicon glyphicon-modal-window"></span>新增</button>
	</div>
	
	<!-- // 一般查询区域-->
	<div id="divSearchData" class="collapse">
		<a class="label label-primary" style="font-size:14px;border-bottom-left-radius:0px;border-bottom-right-radius:0px;" href="#divSearchData"  data-toggle="collapse" title="点击隐藏">一般查询条件</a>
		<form id="fmAssSearch" style="border:1px solid #eee;padding:10px 0px 10px 0px;">
			<input class="sr-only" name="reqObj" type="text" value="" />
			<div class="row myRow">
			<div class="form-group col-sm-4">
				<label class="" for="brand_model">名称（品牌型号）</label>
				<input class="form-control" id="brand_model" name="brand_model" type="text" value="" placeholder="...不限">
										
			</div>
			<div class="form-group col-sm-2">
				<label class="" for="assnum">编号</label>
				<input class="form-control" id="assnum" name="assnum" type="text" value="" placeholder="...不限">
										
			</div>
			
			<div class="form-group col-sm-3">
				<label class="" for="code">卡号</label>
				<input class="form-control" id="code" name="code" type="text" value="" placeholder="...不限">
										
			</div>
			
			<div class="form-group col-sm-3">
				<label class="" for="bar_code">条形码号</label>
				<input class="form-control" id="bar_code" name="bar_code" type="text" value="" placeholder="...不限">
										
			</div>
			</div>
			
			<div class="row myRow">
			<div class="form-group col-sm-4">
				<label class="control-label" for="dept_now">现使用部门</label>
				<!-- <select multiple class="form-control" id="searchPatType" name="searchPatType" > -->
				<select class="form-control" id="selectDeptNow" name="dept_now" >
						<option value="">d1</option>
				</select>
			</div>
			<div class="form-group col-sm-2">
				<label class="control-label" for="status_now">状态</label>
				<!-- <select multiple class="form-control" id="searchPatType" name="searchPatType" > -->
				<select class="form-control" id="selectStatusNow" name="status_now" >
						<option value="">s1</option>
				</select>
			</div>
			
			<div class="form-group col-sm-2">
				<label class="" for="place_now">现放置地点</label>
				<select class="form-control" id="selectPlaceNow" name="place_now" >
						<option value="">p1</option>
				</select>
			</div>
			<div class="form-group col-sm-2">
				<label class="control-label" for="keeper_now">现保管人</label>
				<input class="form-control" name="keeper_now" type="text" value="" placeholder="...不限" />
			</div>
			
			<div class="form-group col-sm-2">
				<label class="control-label" for="status_now_user_name">登记人</label>
				<input class="form-control" name="status_now_user_name" type="text" value="" placeholder="...不限" />
			</div>
			</div>			
			
			<div class="row myRow">
			<div class="pull-right">
				<button id="btnSearch" type="button" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-search"></span>查询</button>
			
				<button id="btnSearchReset" type="button" class="btn btn-primary btn-sm">条件重置</button>
			</div>
			</div>
		
		</form>
		</br>
	</div>
	
	<!-- // 条形码查询区域-->
	<div id="divSearchByBarcode" class="collapse">
		<a class="label label-primary" style="font-size:14px;border-bottom-radius:0px;border-bottom-left-radius:0px;border-bottom-right-radius:0px;" href="#divSearchByBarcode"  data-toggle="collapse" title="点击隐藏">条形码查询</a>
		<!-- // TP5的include命令，相对路径，以TP5入口文件index.php为起点的路径-->
		{include file="../application/common/decodeBarcode.html"}
		<br>
	</div>
	<!-- // AssList表格排序信息汇总组件 -->
	<div id="divTblSortData" data-ass-type="{$assType}" data-sort-name="{$sortData.sortName}" data-sort-order="{$sortData.sortOrder}" data-list-rows="{$sortData.listRows}" data-page-num="{$sortData.pageNum}" data-show-ass-id="{$sortData.showAssId}" class="sr-only"></div>
	
	<div id="divLoadAssList">
		<p class="text-center" style="font-size:20px;">加载中……</p>
	</div>
		

</div>
<!-- Modal "modalAssSingle" -->
<div class="modal fade" id="modalAssSingle" role="dialog">
	<div class="modal-dialog modal-lg">
    
      <!-- Modal content-->
      	<div class="modal-content">
        <div class="modal-header bg-info" style="border-radius:5px;">
          	<button type="button" class="close" data-dismiss="modal">&times;</button>
		  
          	<h4 class="title"></h4>
        </div>
		
        <div class="modal-body">
			<!-- // 单个asset增删改查页面显示位置，需load其他模板文件的div-->
			<div id="divLoadAssSingle"><p class="text-center" style="font-size:28px;">加载中……</p></div>
		</div>
		
		<div class="modal-footer" hidden="true">
        	<input type="button" class="btn btn-primary btn-sm" data-dismiss="modal" value="返回">  
          
        </div>
		</div>
	</div>

</div>
<!--/ Modal "modalAssSingle" -->

<!-- /pagewrap  -->

<script type="text/javascript">

var assType='{$assType}';

var urlPrefix='{$home}/dashboard/asset/';

//将json对象转为JSON对象数组，便于应用数组的.forEach等函数进行自定义处理
var fnJsonToArr=(jsonObj)=>{
	var nameArr=Object.keys(jsonObj);
	var valArr=Object.values(jsonObj);
	var arr=[]
	for(var i=0;i<nameArr.length;i++){
		arr[i]={'name':nameArr[i],'val':valArr[i]};
	}
	return arr;
};

const conAssNumArr=fnJsonToArr({$numObj});
<!-- var conAssNumArr=fnJsonToArr({$numObj}); -->
<!-- const conAssLabelArr=fnJsonToArr({$conAssStatusLabelArr}); -->
var conAssLabelArr=fnJsonToArr({$conAssStatusLabelArr});
<!-- console.table(conAssNumArr); -->
<!-- console.log(conAssLabelArr); -->

//由表格头字段创建数组
var tblColObjArr=[];

var buildAssNumSpan=(type,numArr)=>{
	
	var label='';
	var num=0;
	//得到asset的type/Num/Label对应关系数组
	var typeNumLabelArr=(numArr,labelArr)=>{
		var arr=[];
		var label='info';
		for(var i=0;i<numArr.length;i++){
			for(var n=0;n<labelArr.length;n++){
				if(labelArr[n].name==numArr[i].name){
					label=labelArr[n].val;
					break;
				}
			}
			arr[i]={'name':numArr[i].name,'num':numArr[i].val,'label':label};
		}
		return arr;
	};
	numArr=(numArr==undefined)?conAssNumArr:numArr;
	var arr=typeNumLabelArr(numArr,conAssLabelArr);
		
	for(var i=0;i<arr.length;i++){
		if(type==arr[i].name){
			label=arr[i].label;
			num=arr[i].num;
			break;
		}
	}
	if(num){
		htmlStr='<span class="label label-'+label+' spClass">'+num+'</span>';
	}else{
		htmlStr='<span class="spClass">'+num+'</span>';
		$(this).removeClass('aPill');
		$(this).closest('li').addClass('disabled');
	}
	return htmlStr;
};


//**函数名：glyphiconTextChange
 	//* 作用：obj内含的glyphicon进行变换
	//* 参数1：obj，String。值：必须，要交换glyphicon的obj
	//* 参数2：iconText1，Json。值：必须，{icon:'glyphicon-xx',text:'xx'}。
	//* 参数3：iconText2，Json。值：必须，{icon:'glyphicon-yy',text:'yy'}。
	//* 无返回值
var glyphiconTextChange=(obj,iconText1,iconText2)=>{
	iconText1=$.extend({icon:'glyphicon-collapse-up',text:'隐藏搜索'},iconText1);
	iconText2=$.extend({icon:'glyphicon-collapse-down',text:'显示搜索'},iconText2);
	if(obj.find('.'+iconText2.icon).length){
	    obj.find('.glyphicon').removeClass(iconText2.icon).addClass(iconText1.icon).next('span').html(iconText1.text);
    }else{
	    obj.find('.glyphicon').removeClass(iconText1.icon).addClass(iconText2.icon).next('span').html(iconText2.text);
    }
};

//**函数名：ajaxShowSelect
 	//* 作用：本页面ajax过程向服务器请求特定单选框内容所需数据，并组装好HTML语句
	//* 参数url，类型：字符串。值：不为空。说明：ajax操作的URL。
	//* 参数sendData，类型：数值。值：传送给后端的键值对数据。
	//* 参数obj，类型：对象。值：必须，单选框的对象名称
	//*参数attach，类型：json数组。值：可为空，需要附加的单选框的键值对，[{"text":"...不限","val":"0"},{"text":"xx","val":"xx"}]
	//*参数selected，类型：字符。值：字符，可为空。
	//* 返回值：无
var ajaxShowSelect=(options)=>{
	var defaults={
		'url':urlPrefix+'selectRes',
		'attach':[{"text":"...不限","val":"0"}],
		'sendData':'',
		'obj':'',
		'selected':'',
	};
	var data = $.extend({},defaults, options);
	var arrJson=data.attach;
	var req=data.sendData.req;
	var obj=data.obj;
	var selected=data.selected;
	var str='';
	
	$.post(data.url,data.sendData,function(result){
		if(arrJson.length){
			for(i=0;i<arrJson.length;i++){
				str+='<option value="'+arrJson[i].val+'">'+arrJson[i].text+'</option>';
			}
		}
		// result数组,取出value值组装HTML语句
		$.each(result,function(n1,v1){
			str+='<option value="'+v1+'">'+v1+'</option>';	
		});
		<!--// 清空单选框Obj的所有选项-->
		obj.empty();
		<!--// 添加单选框Obj的新选项-->
		obj.append(str);
		<!-- // value=selected 的项为选定项-->
		if (selected!=''){
			obj.val(selected);
		}
		
		//没有option就隐藏自己和有关联的同伴
		if(obj.find('option').length==0){
			obj.closest('div').hide();
			<!-- obj.closest('form').find('[name="status_now_desc"]').closest('div').hide(); -->
		}else{
			obj.closest('div').show();
			<!-- obj.closest('form').find('[name="status_now_desc"]').closest('div').show(); -->
		}

	});
};

//**函数名：loadAssList
 	//* 作用：加载assList页面内容
	//* 参数1：listRows，Int。值：可为空，每页显示的记录行数。默认为10。
	//* 参数2：sortName，String。值：可为空，排序字段名称。默认为‘_TOPIC’。
	//* 参数3：sortOrder，String。值：可为空，排序方式。默认为'_ASC'。
	//* 参数4：pageNum，Int。值：可为空，当前页数。默认为1。
	//* 参数5：showAssId，Int。值：可为空。加底色的行的assId,默认为0。
	//* 参数6：serchWord，Array。值：可为空，用户搜索关键词键值对。默认为空。
var loadAssList=()=>{
	//排序有关的参数都从$('#divTblSortData')获取
	var obj=$('#divTblSortData');
	var sortData={
		'listRows':obj.data('listRows'),
		'sortName':obj.data('sortName'),
		'sortOrder':obj.data('sortOrder'),
		'pageNum':obj.data('pageNum'),
		'assType':obj.data('assType'),
		'showAssId':obj.data('showAssId')
	};
	var deptNowArr=$('#selectDeptNow').val();
	var statusNowArr=$('#selectStatusNow').val();
	var placeNowArr=$('#selectPlaceNow').val();
	//排序有关的参数默认值
	var sortDataDefault={'listRows':10,'sortName':'assnum','sortOrder':'asc','pageNum':1,'assType':'_ASSS_USUAL','showAssId':0};
	sortData=$.extend({},sortDataDefault,sortData);
	
	var assType=sortData.assType;
	<!-- obj.data('assType',assType) -->
	
	//是否出现‘新增’按钮
	if(assType=='_ASSS6'){
		$('[data-ass-oprt="_CREATE"]').hide();
	}else{
		$('[data-ass-oprt="_CREATE"]').show();
	}
	
	//用户搜索有关键值对从表单$('#fmIssPatSearch')获取
	var formData=new FormData($('#fmAssSearch')[0]);
	
	var searchData={};
	//使用Map对象的forEach方法组装键值对
	formData.forEach(function(val,key){
		//非0非空的值才进行组装
		if(val!='' && val!=0){
			searchData[key]=val;
		}
	});
	
	<!-- // 转换成json字符串-->
	JSON.stringify(searchData);
	
	$('#divLoadAssList').html('<p class="text-center" style="font-size:20px;">加载中……</p>').load(urlPrefix+'assList',
		{'assType':assType,'sortData':sortData,'searchData':searchData},
		function(responseTxt, statusTxt, xhr){
			sortOrderToggle();
			if(sortData.showAssId){
				$('tbody tr').removeClass('bg-warning');
				//sortData.showAssId所在行上底色
				$('.tdAssOprt').each(function(){
					if($(this).data('assId')==sortData.showAssId){
						$(this).closest('tr').addClass('bg-warning');
					}
				});
			}
			
			//是否显示assList.html中的$('#spSearchResult')组件
			if(Object.keys(searchData).length){
				$('#spSearchResult').show();
			}else{
				$('#spSearchResult').hide();
			}
			<!-- //设定$('#fmAssSearch')内的select组件的option -->
			$.when(
				ajaxShowSelect({'sendData':{'req':$('#selectDeptNow').attr('name'),'assType':assType},'selected':deptNowArr,'obj':$('#selectDeptNow')}),
				ajaxShowSelect({'sendData':{'req':$('#selectStatusNow').attr('name'),'source':'db','assType':assType},'selected':statusNowArr,'obj':$('#selectStatusNow')}),
				ajaxShowSelect({'sendData':{'req':$('#selectPlaceNow').attr('name'),'assType':assType},'selected':placeNowArr,'obj':$('#selectPlaceNow')})
			).then(
				function(data, textStatus, jqXHR){
					//ajax成功,
					
				},
				function(){
					//ajax失败
					$.alert('加载失败，请稍后再试！');
				}
			);
			
			//根据tblColObjArr显示、隐藏col
			tblColshowChange(tblColObjArr);	
			
			//assList.html页面的一些初始化
			let aObj=$('a[href="'+window.location.hash+'"]').filter('.aPill'),
				htmlStr=aObj.find('.spType').html(),
				spClass=aObj.find('.spClass').attr('class');
			<!-- console.log('loadAssList func'); -->
			aObj.tab('show');
			$('.spAssType').html(htmlStr);
			$('#spAssNum').attr('class','');
			if(spClass){
				$('#spAssNum').addClass(spClass);
			}else{
				$('#spAssNum').addClass('label label-info');
			}
			<!-- console.dir($('a.aAnchor[href="#_ASSS_USUAL"]')); -->
			<!-- console.dir(aObj.find('.spClass').attr('class')); -->
		}
	);
};

//函数名：sortOrderToggle
//作用：对选定的assList列表字段进行升序降序转换，改变该字段表头显示格式
var sortOrderToggle=()=>{
	var obj='';
	var glyAsc='&nbsp;<span class="small glyphicon glyphicon-sort-by-attributes"></span>';
	var glyDesc='&nbsp;<span class="small glyphicon glyphicon-sort-by-order-alt"></span>';
	var sortOrder=$('#divTblSortData').data('sortOrder');
	var sortName=$('#divTblSortData').data('sortName');
	$('thead a').removeClass('label label-primary');
	
	$('thead a').each(function(){
		if(sortName==$(this).data('sortName')){
			obj=$(this);
		}else{
			$(this).tooltip({placement: 'bottom'});
		}
	});
	
	if(obj.length){
		obj.addClass('label label-primary');
		if(sortOrder == 'asc'){
			//当前为升序
			obj.append(glyAsc);
			obj.tooltip({title:'当前为升序。点击后降序',placement: 'top'});
			obj.data('sortOrder','desc');
		}else{
			//当前为降序
			obj.append(glyDesc);
			obj.tooltip({title:'当前为降序。点击后升序',placement: 'top'});
			obj.data('sortOrder','asc');
		}
	}		
};

//所有查询表单重置
var fmReset=()=>{
	var fm=$('form');
	
	fm.each(function(){
		$(this)[0].reset();
		$(this).find('.form-control').removeClass('alert-info');
		if($(this).attr('id')=='fmRun'){
			$(this).next().hide().find('span.alert-info').text('');
		}
	});
};


//自调用匿名函数立即执行的特点，进行页面初始化，有顺序讲究。
(function($){
	$('#divTblSortData').data('assType',assType);
	
	loadAssList();
	
	//.aPill添加内容
	$('.aPill').each(function(){
		var type=$(this).data('assType');
		var htmlStr=buildAssNumSpan(type,conAssNumArr);
		$(this).find('.spClass').remove();
		$(this).find('.spType').after(htmlStr);
	});
	//ul.nav调整.aPill
	$('#ulAssType.nav-pills').find('a').each(function(){
		//缩小padding
		$(this).css('padding','5px 10px');
		//去掉底部边框圆角
		$(this).css({'border-bottom-right-radius':'0px','border-bottom-left-radius':'0px'});
		//调整内部span.label的大小
		$(this).find('.spClass').css({'padding-bottom':'1px','margin-bottom':'2px'});
	});
	// 设置各类tooltip
	$('#divTopBtn').tooltip({selector:'[title]',triger:'hover click',placement: 'auto left',delay: {show: 200, hide: 100},html: true });
	
	$('a[href="#divAssTotal"]').tooltip({triger:'hover',placement: 'auto right',title:'显示/隐藏固定资产总数'});	
	
})(jQuery);

$(document).ready(function(){
	var searchDataChanged=false;
	
	//点击.aPill中的各个按钮后，load相应的assList-->
	$('.aPill').click(function(){
		assType=$(this).data('assType');
		$('#divTblSortData').data('assType',assType);
		$(this).tab('show');
		<!-- window.location.href=urlPrefix+'assList'; -->
		//搜索表单重置
		fmReset();
		loadAssList();
    });
	//控制collapse
	$('#divTopBtn').find('a[data-toggle="collapse"]').click(function(){
		//关闭所有与a[data-toggle="collapse"]有关的div块。与a 中的collapse属性配合，实现点击a时只出现a控制的div块。
		$('.content-body').children('div.collapse').collapse('hide');
	});
	
	<!-- // 页面刷新 -->
	$('#btnRefresh').click(function(){
		//所有表单重置
		fmReset();
		
		//隐藏搜索条件
		<!-- $('#divSearchData').collapse('hide'); -->
		$('.collapse').collapse('hide');
		//
		loadAssList();
	});
	
<!-- //表单$('#fmAssSearch')有关的代码块 -->
	$('#fmAssSearch .form-control').change(function(){
		if($(this).val()!=0){
			//表单输入框附加底色
			$(this).addClass('alert-info');
			searchDataChanged=true;
		}else{
			//表单输入框去掉附加底色
			$(this).removeClass('alert-info');
		}
	});
	
	//表单提交，显示asset结果
	$('#btnSearch').click(function(){
		var assType=$('#divTblSortData').data('assType');
		$('#fmAssSearch [name="reqObj"]').val('form');
		//检查搜索表单的值是否有变化，若有变化，排序参数pageNum要重设为1，避免出现在当前分页无法显示查询结果的情况
		if(searchDataChanged){
			$('#divTblSortData').data('pageNum',1);
		}
		loadAssList();
	});
	
	//表单重置
	$('#btnSearchReset').click(function(){
		fmReset();
	});

});
</script>
