<!-- issPatList.html -->

<!-- pagewrap  -->	
<div id="divIssList">
	<div class="row myRow">
		<div class="text-right">
			<strong class="spIssStatus"></strong><span id="spSearchResult" class="label label-info">查询结果</span>&nbsp;记录数：<span id="spIssNum">{$searchResultNum}</span>
		</div>
		<P id="pDis"></P>
	</div>	
	<div class="table-responsive" style="overflow: auto;"> 
		<table id="tblIssList" class="table table-bordered table-hover table-condensed" >
			<caption class="text-center" style="border-bottom:1px solid #eee;">
			<h4><span class="spIssEntName"></span>事务信息列表&nbsp;<strong class="spIssStatus"></strong>
			   	<div class="btn-group">
      				<button type="button" class="btn btn-xs btn-primary dropdown-toggle" data-toggle="dropdown" >选择显示字段<span class="caret"></span></button>
      				<ul class="dropdown-menu" >
						<li><div class="checkbox"><label><input type="checkbox" value="all" checked><span class="text-primary">全选</span></label></div></li>
						<li class="divider"></li>
					</ul>
    			</div>
			</h4>
			</caption>
			<colgroup></colgroup>
			<thead>
				<tr>
					<th class="text-center">序号</th>
					<th><a data-sort-name="topic">事务标题</a></th>
					<th><a data-sort-name="issnum">事务编号</a></th>
					<th><a data-sort-name="status">事务现状</a></th>
					<th><a data-sort-name="statusdescription">现状说明</a></th>
					<th><a data-sort-name="create_time">创建时间</a></th>
					<th><a data-sort-name="update_time">现状登记时间</a></th>
					<th><a data-sort-name="dept">事务发起部门</a></th>
					<th><a data-sort-name="writer">事务申请人</a></th>
					<th><a data-sort-name="registrar">现状登记人</a></th>
					
					<th><a data-sort-name="issEntName"><span class="spIssEntName"></span>名称</a></th>
					<th><a data-sort-name="issEntType"><span class="spIssEntName"></span>类型</a></th>
					<th><a data-sort-name="issEntStatus"><span class="spIssEntName"></span>现状</a></th>
					
					<th class="text-center">操作</th>
				</tr>
			
			</thead>
			<tbody><!-- 此处显示数据库查询后的数据集 -->
				{volist name="issList" id="vo" empty=""}
				<tr class="text-right" data-show-iss-id="{$vo.id}" >
					<td class="text-center">{$i+($sortData.pageNum-1)*$sortData.listRows}</td>	
					<td><a href="{$home}/issue/index/issinfo/id/{$vo.id}" target="_blank" title="事务详情" >{$vo.topic}</a></td>
					<td>{$vo.issnum}</td>
					<td><a href="{$home}/issue/index/issrecords/id/{$vo.id}" target="_blank" title="事务状态过程记录"><span class="spStatus">{$vo.status}</span></a></td>
					<td>{$vo.statusdescription}</td>
					<td>{$vo.create_time}</td>
					<td>{$vo.update_time}</td>
					<td>{$vo.dept}</td>
					<td>{$vo.writer}</td>
					<td>{$vo.registrar}</td>
					
					<td><a href="{$home}/patent/index/patinfo/id/{$vo.issmap_id}" target="_blank" title="专利详情">{$vo[$mdlMethod]['topic']}</a></td>
					<td>{$vo[$mdlMethod]['type']}</td>
					<td>{$vo[$mdlMethod]['status']}</td>
					
					<td class="tdIssOprt text-right" data-iss-status="{$vo.status}" data-iss-id="{$vo.id}" data-iss-topic="{$vo.topic}" ></td>				
				</tr>
				{/volist}
			</tbody>
			
		</table>
		
	</div>
	
	
	<div id="divListRows" class="row text-right" style="padding-top:10px;">
		<!-- // 分页组件渲染 -->
		<div class="col-sm-10">{$pageSet->render()}</div>
		
		<div class="form-group form-group-sm col-sm-2">
			<span class="">每页显示记录数：</span>
			<select class="form-control" id="listRows">
				<option value="5">5</option>
				<option value="10">10</option>
				<option value="20">20</option>
				<option value="50">50</option>
			</select>
						
		</div>
	
	</div>
	<p id="pIssNone" class="text-center" data-show="false"><span class="label label-default" style="font-size:16px;">无符合条件信息</span></p>	
</div>

<!-- // pagewrap  -->
<script>
<!-- // -->
//iss状态与操作对应关系
var issStatusOprtArr={$statusOprtArr};
<!-- console.dir(issStatusOprtArr); -->

//iss权限与操作对应关系
var issAuthOprtArr='';

//根据columnToggleArr的值，改变复选框，显示/隐藏对应column
var columnToggle=()=>{
	//column，一个([data-hide-val="'+el.val+'"]的th、td集合
	columnToggleArr.forEach(function(el){		
		//复选框
		$('#tblIssList input').each(function(){
			if($(this).val()==el.val){
				//改变复选框的值
				$(this).prop('checked',el.showFlag);
				//改变复选框的字体颜色
				$(this).next().removeClass('text-primary text-muted');
				if(el.showFlag){
					$(this).next().addClass('text-primary');
					//显示col
					$('#tblIssList').find('[data-hide-val="'+el.val+'"]').show();
				}else{
					$(this).next().addClass('text-muted');
					//隐藏col
					$('#tblIssList').find('[data-hide-val="'+el.val+'"]').hide();
				}
			}
		});
	});	
};
//对选定的issList列表字段进行升序降序转换，改变该字段表头显示格式
var sortOrderToggle=()=>{
	let obj='',
		glyAsc='&nbsp;<span class="small glyphicon glyphicon-sort-by-attributes"></span>',
		glyDesc='&nbsp;<span class="small glyphicon glyphicon-sort-by-order-alt"></span>',
		sortOrder=$('#divTblSortData').data('sortOrder'),
		sortName=$('#divTblSortData').data('sortName');
		
	$('#tblIssList thead a').removeClass('label label-primary');
	//选中进行排序的列向左对齐，添加底色
	$('#tblIssList tbody').find('[data-hide-val="'+sortName+'"]').addClass('text-left bg-info');
	
	$('#tblIssList thead a').each(function(){
		if(sortName==$(this).data('sortName')){
			obj=$(this);
		}else{
			$(this).tooltip({placement: 'bottom'});
		}
	});
	
	if(obj.length){
		obj.addClass('label label-primary');
		if(sortOrder == 'asc'){
			//当前为升序
			obj.append(glyAsc).data('sortOrder','desc').tooltip({title:'当前为升序。点击后降序',placement: 'top'});
		}else{
			//当前为降序
			obj.append(glyDesc).data('sortOrder','asc').tooltip({title:'当前为降序。点击后升序',placement: 'top'});
		}
	}		
};

//根据查询记录数决定页面的组件显示
var setShowCom=(num)=>{
	let obj=$('#pIssNone'),
		searchEnt=$('#searchEnt').val(),
		resultStr='',
		classStr=$('ul.nav-pills li.active').children('.aIss').find('.spLabel').attr('class');
	
	$('#spSearchResult').hide();
	if(num){
		obj.hide().data('show',false).prevAll().show();
		$('#spIssNum').addClass(classStr);
		resultStr='<p><span class="label label-info">查询结果</span>&nbsp;记录数：'+num+'</p>';
	}else{
		obj.show().data('show',true).prevAll().hide();
		resultStr='<p><span class="label label-default">查询结果</span>&nbsp;记录数：0</p>';
	}
	//根据searchEnt实现不同的弹出窗
	switch(searchEnt){
		case 'form':
			$('#spSearchResult').show();
			$.alert('<span class="label label-info">查询结果</span>&nbsp;记录数：<span>'+num+'</span>');
			break;
		
		default:
		
			break;
	}
};
//设定搜索表单的各项内容
var setFmSearch=(fmobj,optObj)=>{
	let fcSet=fmobj.find('.form-control'),
		keyArr=Object.keys(optObj),
		valArr=Object.values(optObj);
	
	keyArr.forEach(function(item,index){
		for(var i=0;i<fcSet.length;i++){
			let subCom=fcSet.eq(i),
				name=subCom.attr('name');
			while(item==name){
				<!-- console.log(typeof valArr[index]); -->
				//valArr[index]是否为数组
				if(typeof valArr[index] == 'Object'){
					valArr[index].forEach(function(v,k){
						subCom.val(v);
						console.log(v);	
					});
				}else{
					subCom.val(valArr[index]);
				}
				break;
			}
		}
		<!-- console.log(item,valArr[index]);	 -->
	});
	
};
//生成oprt组件的HTML字符串
var getOprtComHtml=(status)=>{
	let i=0,
		btnHtml='',
		arr=issStatusOprtArr,
		oprtArr=[];
		//权限与操作对应数组
		//authArr=
		
	<!-- console.dir(arr); -->
	
	arr.forEach(function(v,k){
		if(status==v.status || status==v.statusChi){
			//状态对应的所有操作及各个操作的后续状态
			oprtArr=v.oprt;
		}
	});
	
	oprtArr.forEach(function(v,k){
		let name=v.name,
			statusObj=v.nextStatus,
			e=oprtComAttrArr,
			enArr=[],
			chiArr=[];
			
		if(!Array.isArray(statusObj)){
			enArr=Object.keys(statusObj);
			chiArr=Object.values(statusObj);
		}
		//有后续状态的才生成oprt组件的HTML字符串			
		if(enArr.length){
			if(btnHtml=='无'){
				btnHtml='';
			}
			
			for(i=0;i<e.length;i++){
				if(name==e[i].nameEn || name==e[i].nameChi){
					btnHtml+='<button class="btn btn-xs '+e[i].color.btn+' btnIssOprt" title="'+e[i].title+'" data-iss-oprt="'+e[i].nameEn+'" data-toggle="tooltip"  style="margin:2px;"><span class="'+e[i].gly+'"></span>&nbsp;'+e[i].nameChi+'</button>';
					break;
				}
			}
		}else{
			btnHtml='无';
		}	
	});
	return btnHtml;
};

var btnClickShowModel=(optObj)=>{
	let oprt=optObj.oprt,
		arr=oprtComAttrArr,
		mdl=$('#modalIssSingle'),
		spStr='',
		url=urlPref+'fmIssSingle',
		bgAll='bg-info bg-warning bg-primary bg-danger',
		bg='bg-info',
		loadStr='<p class="text-center" style="font-size:28px;">加载中……</p>';
		
	//生成$('#modalAssSingle')标题上的span组件
	for(var i=0;i<arr.length;i++){
		let el=arr[i];
		if(oprt==el.nameEn){
			spStr='<span class="'+el.color.btn+'" style="padding:3px 5px;border-radius:3px;"><span class="'+el.gly+'"></span>&nbsp;'+el.nameChi+'</span>';	
			bg=	el.color.bg;		
			break;
		}
	}
	
	mdl.find('.modal-header').removeClass(bgAll).addClass(bg);
	mdl.find('.title').html('【'+spStr+'】'+entNameChi+'事务记录');
	//显示modal
	mdl.modal();
	
	$('#divFmIssSingle_Load').html(loadStr).load(url,optObj);
};	

//自调用匿名函数立即执行的特点，进行页面初始化。
(function($){
	let statusText=$('ul.nav-pills li.active').children('.aIss').find('.spType').text();
	//更新$('.spIssStatus')的text
	$('.spIssStatus').html(statusText);
	
	//每个$('#tblIssList thead a')添加属性
	$('#tblIssList thead a').attr({'href':window.location.hash,'data-title':'点击排序','data-toggle':'tooltip'}).closest('th').addClass('text-center');
	
	setShowCom({$searchResultNum});
	buildColumnToggleCom();
	columnToggle();
	sortOrderToggle();
	trAddBgColor();
	
	if(Object.keys({$searchData}).length){
		setFmSearch($('#fmIssSearch'),{$searchData});
	}
	
	//每个.tdIssOprt根据该行记录的data-iss-status="{$ vo.status}"添加相应的a标签
	$('.tdIssOprt').each(function(){
		let btnHtml=getOprtComHtml($(this).data('issStatus'));
		$(this).html(btnHtml);
	});
	
	<!-- $('#pDis').html('{$issTest}'); -->
	// 激活tooltip
	$('[title]').tooltip();
	
})(jQuery);

$(document).ready(function(){
	
	//选择显示/隐藏字段	
	$('#tblIssList ul input').click(function(){
		//复选框点击后的值
		let checkVal=$(this).prop('checked'),
			val=$(this).val(),
			arr=columnToggleArr;
		if(val=='all'){
			arr.forEach(function(el,index){
				el.showFlag=checkVal;
			});
		}else{
			for(let i=0;i<arr.length;i++){
				if(val==arr[i].val){
					arr[i].showFlag=checkVal;
				}
			}
		}
		//修改columnToggleArr
		columnToggleArr=arr;
		
		columnToggle();	
	});
	<!-- //表格每页显示记录行数 -->
	$('#listRows').val('{$sortData.listRows}'); 
	
	$('#listRows').change(function(){
		var listRows=$(this).val()*1;
		//排序有关的值向$('#divTblSortData')汇集
		if(listRows){
			$('#divTblSortData').data('listRows',listRows);
			//分页从第一页开始
			$('#divTblSortData').data('pageNum',1);
		}
		//调用index.html中的loadAssList()
		loadIssList();
	});	
	//排序
	$('#tblIssList thead a').click(function(){
		let sortName=$(this).data('sortName'),
			sortOrder=$(this).data('sortOrder');
		//排序有关的值向$('#divTblSortData')汇集
		$('#divTblSortData').data('sortName',sortName);
		$('#divTblSortData').data('sortOrder',sortOrder);
		$('#divTblSortData').data('pageNum',1);
		//调用index.html中的loadAssList()
		loadIssList();
		
	});	
	
	<!-- // 点击分页中的a，表格中的内容根据a中的属性值进行排序 -->
	$('#divListRows a').click(function(evt){
		// a所在分页页数
		let pageStr=$(this).text(),pageNum,
		//(li.active)所代表的页数
			pageNumActive=$('#divListRows li.active').children('span').text(),
			sortName=$('thead').find('.label').data('sortName');

		evt.preventDefault();
		
		switch(pageStr){
			case'»':
				//用"*"确保得到的是加法运算结果，而不是字符串
				pageNum=(pageNumActive*1+1);
			break;
			
			case'«':
				pageNum=(pageNumActive*1-1);
			break;
			
			default:
				pageNum=pageStr*1;
			break;
		}
		//排序有关的值向$('#divTblSortData')汇集
		if(pageNum){
			$('#divTblSortData').data('pageNum',pageNum);
		}
		//调用index.html中的loadIssList()
		loadIssList();
	});
	
	//
	$('#tblIssList tbody a').click(function(){
		$('#divTblSortData').data('showIssId',$(this).closest('tr').data('showIssId'));
		
		trAddBgColor();
	});
	//页面内所有'.btnIssOprt'的click事件
	$('.btnIssOprt').click(function(){
		let oprt=$(this).data('issOprt'),
			dataFromObj=$(this).closest('td'),
			dataObj={'oprt':oprt,'id':dataFromObj.data('issId')};
		
		//去掉所有行的底色
		$('tr').removeClass('bg-warning');
		//给本行上底色
		$(this).closest('tr').addClass('bg-warning');
		//排序有关的值向$('#divTblSortData')汇集。发送本行的assId，便于刷新后本行继续加底色
		$('#divTblSortData').data('showIssId',dataFromObj.data('issId'));
		btnClickShowModel(dataObj);
	});

});

//生成控制显示/隐藏字段的组件
function buildColumnToggleCom(){
	let arr=columnToggleArr;
	//生成单选框组件属性数组
	if(arr.length==0){
		$('#tblIssList').find('th').each(function(){
			<!-- tblColObjArr.push($(this).text()); -->
			let nameEn=$(this).children('a').data('sortName'),
				nameChi=$(this).text();
			<!-- let nameChi=$(this).children('a').html(); -->
			if(nameEn){
				arr.push({'nameChi':nameChi,'val':nameEn,'showFlag':true});
			}else{
				arr.push({'nameChi':nameChi,'val':0,'showFlag':false});
			}
		});
		//附加value="all"的input复选框信息
		arr.push({'nameChi':'全选','val':'all','showFlag':$('#tblIssList ul input').eq(0).prop('checked')});
		//更新组件属性数组
		columnToggleArr=arr;
	}
	//由属性数组生成单选框组件
	arr.forEach(function(el,index){
		let obj=$('#tblIssList');
		let trObj=$('#tblIssList').find('tr');
		//添加col标签
		obj.find('colgroup').append('<col data-col-index="'+index+'">');
			
		//生成显示字段的多选框内容，
		if(el.val && el.val!='all'){
			let labelObj=$('<label></label>').prepend($('<input />').attr({'type':'checkbox','checked':true}).val(el.val)).append($('<span></span>').addClass('text-primary').html(el.nameChi)),
				divObj=$('<div></div>').append(labelObj).addClass('checkbox');
			obj.find('ul').append($('<li></li>').append(divObj));
		}
		//每个th、td添加data-hide-val=""，相同的data-hide-val=""用于组合成一个col
		trObj.each(function(){
			if(el.val){
				$(this).children().eq(index).attr('data-hide-val',el.val);
			}
		});	
	});
	
	//对生成的控制显示隐藏字段的单选框格式进行微调
	$('#tblIssList caption div.checkbox').css('padding-left','10px').find('input').css('margin-top','0');	
};

//对点中的a所在行上底色
function trAddBgColor(){
	let showId=$('#divTblSortData').data('showIssId'),
		obj=$('#tblIssList tbody');
	//去掉所有行的底色
	obj.find('tr').removeClass('bg-warning');
	//给showId所在行上底色
	obj.find('[data-show-iss-id="'+showId+'"]').addClass('bg-warning');
}

</script>

