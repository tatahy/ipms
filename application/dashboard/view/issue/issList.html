<!-- issPatList.html -->

<!-- pagewrap  -->	
<div id="divIssList">
	<div class="row myRow">
		<div class="text-right">
			<strong class="spIssStatus"></strong><span id="spSearchResult" class="label label-info">查询结果</span>&nbsp;记录数：<span id="spIssNum">{$searchResultNum}</span>
		</div>
		<P id="pDis"></P>
	</div>	
	<div class="table-responsive" style="overflow: auto;"> 
		<table id="tblIssList" class="table table-bordered table-hover table-condensed" >
			<caption class="text-center" style="border-bottom:1px solid #eee;">
			<h4><span class="spIssEntName"></span>事务信息列表&nbsp;<strong class="spIssStatus"></strong>
			   	<div class="btn-group">
      				<button type="button" class="btn btn-xs btn-primary dropdown-toggle" data-toggle="dropdown" >选择显示字段<span class="caret"></span></button>
      				<ul class="dropdown-menu" >
						<li><div class="checkbox"><label><input type="checkbox" value="all" checked><span class="text-primary">全选</span></label></div></li>
						<li class="divider"></li>
					</ul>
    			</div>
			</h4>
			</caption>
			<colgroup></colgroup>
			<thead>
				<tr>
					<th>序号</th>
					<th><a data-sort-name="topic">事务标题</a></th>
					<th><a data-sort-name="issnum">编号</a></th>
					<th><a data-sort-name="status">现状</a></th>
					<th><a data-sort-name="statusdescription">现状说明</a></th>
					<th><a data-sort-name="create_time">创建时间</a></th>
					<th><a data-sort-name="update_time">现状登记时间</a></th>
					<th><a data-sort-name="issEntName"><span class="spIssEntName"></span>名称</a></th>
					<th><a data-sort-name="issEntType"><span class="spIssEntName"></span>类型</a></th>
					<th><a data-sort-name="issEntStatus"><span class="spIssEntName"></span>状态</a></th>
					<th><a data-sort-name="dept">事务发起部门</a></th>
					<th><a data-sort-name="writer">事务撰写人</a></th>
					<th><a data-sort-name="registrar">现状登记人</a></th>
					<th class="text-center">操作</th>
				</tr>
			
			</thead>
			<tbody><!-- 此处显示数据库查询后的数据集 -->
				{volist name="issList" id="vo" empty=""}
				<tr class="text-right">
					<td class="text-center">{$i+($sortData.pageNum-1)*$sortData.listRows}</td>	
					<td class="text-center"><a class="aTblIssSingle" href="#issInfo" data-ass-id="{$vo.issmap_id}">{$vo.topic}</a></td>
					<td>{$vo.issnum}</td>
					<td><a class="aIssRecords" href="#issInfo" data-ass-id="{$vo.issmap_id}"><span class="spStatus">{$vo.status}</span></a></td>
					<td>{$vo.statusdescription}</td>
					<td>{$vo.create_time}</td>
					<td>{$vo.update_time}</td>
					<td>{$vo[$mdlMethod]['topic']}</td>
					<td>{$vo[$mdlMethod]['type']}</td>
					<td>{$vo[$mdlMethod]['status']}</td>
					<td>{$vo.dept}</td>
					<td>{$vo.writer}</td>
					<td>{$vo.registrar}</td>
					<td>操作</td>				
				</tr>
				{/volist}
			</tbody>
			
		</table>
		
	</div>
	
	
	<div id="divListRows" class="row text-right" style="padding-top:10px;">
		<!-- // 分页组件渲染 -->
		<div class="col-sm-10">{$pageSet->render()}</div>
		
		<div class="form-group form-group-sm col-sm-2">
			<span class="">每页显示记录数：</span>
			<select class="form-control" id="listRows">
				<option value="5">5</option>
				<option value="10">10</option>
				<option value="20">20</option>
				<option value="50">50</option>
			</select>
						
		</div>
	
	</div>
	<p id="pIssNone" class="text-center" data-show="false"><span class="label label-default" style="font-size:16px;">无符合条件信息</span></p>	
</div>

<!-- /pagewrap  -->
<script>

//根据columnToggleArr的值，改变复选框，显示/隐藏对应column
var columnToggle=()=>{
	//column，一个([data-hide-val="'+el.val+'"]的th、td集合
	columnToggleArr.forEach(function(el){		
		//复选框
		$('#tblIssList input').each(function(){
			if($(this).val()==el.val){
				//改变复选框的值
				$(this).prop('checked',el.showFlag);
				//改变复选框的字体颜色
				$(this).next().removeClass('text-primary text-muted');
				if(el.showFlag){
					$(this).next().addClass('text-primary');
					//显示col
					$('#tblIssList').find('[data-hide-val="'+el.val+'"]').show();
				}else{
					$(this).next().addClass('text-muted');
					//隐藏col
					$('#tblIssList').find('[data-hide-val="'+el.val+'"]').hide();
				}
			}
		});
	});	
};
//对选定的issList列表字段进行升序降序转换，改变该字段表头显示格式
var sortOrderToggle=()=>{
	let obj='',
		glyAsc='&nbsp;<span class="small glyphicon glyphicon-sort-by-attributes"></span>',
		glyDesc='&nbsp;<span class="small glyphicon glyphicon-sort-by-order-alt"></span>',
		sortOrder=$('#divTblSortData').data('sortOrder'),
		sortName=$('#divTblSortData').data('sortName');
		
	$('#tblIssList thead a').removeClass('label label-primary');
	
	$('#tblIssList thead a').each(function(){
		if(sortName==$(this).data('sortName')){
			obj=$(this);
		}else{
			$(this).tooltip({placement: 'bottom'});
		}
	});
	
	if(obj.length){
		obj.addClass('label label-primary');
		if(sortOrder == 'asc'){
			//当前为升序
			obj.append(glyAsc).data('sortOrder','desc').tooltip({title:'当前为升序。点击后降序',placement: 'top'});
		}else{
			//当前为降序
			obj.append(glyDesc).data('sortOrder','asc').tooltip({title:'当前为降序。点击后升序',placement: 'top'});
		}
	}		
};

//根据查询记录数决定页面的组件显示
var pageShowCom=(num,reqObj)=>{
	let obj=$('#pIssNone'),resultStr='',
		classStr=$('ul.nav-pills li.active').children('.aIss').find('.spLabel').attr('class');
	
	if(num){
		obj.hide().data('show',false).prevAll().show();
		$('#spSearchResult').hide();
		$('#spIssNum').addClass(classStr);
		resultStr='<p><span class="label label-info">查询结果</span>&nbsp;记录数：'+num+'</p>';
	}else{
		obj.show().data('show',true).prevAll().hide();
		$('#spSearchResult').show();
		resultStr='<p><span class="label label-default">查询结果</span>&nbsp;记录数：0</p>';
	}
	//根据reqObj实现不同的弹出窗
	switch(reqObj){
		case 'form':
			$.alert('<span class="label label-info">查询结果</span>&nbsp;记录数：<span>'+num+'</span>');
			break;
		case 'barCode':
			let code=$('#divBarcodeImg span.alert-info').text();
			console.log($('#pIssNone').data('show'));
			
			if(code && obj.data('show')==false){
				$.alert('<span class="label label-info">查询结果</span>&nbsp;记录数：<span>'+num+'</span>');
			}else if(code && obj.data('show')){
				//如果识别出条形码并且对条形码的查询结果为0			
				let htmlStr='<p>无条形码【'+code+'】对应的信息记录。</p><p class="text-center">【<span class="text-primary"><span class="glyphicon glyphicon-modal-window">新增</span></span>】信息记录？</p>'
				$.confirm(htmlStr,function(e){
					con=e;
					if(true==con){
						//新增页面弹出	
						btnClickShowModel('{$home}/dashboard/asset/fmAssSingle',{'oprt':'_CREATE','id':0,'reqObj':reqObj});
					}
				}).cancel('否(N)').ok('是(Y)');	
			}else{}
			break;
		default:
		
			break;
	}
};

//自调用匿名函数立即执行的特点，进行页面初始化。
(function($){
	let statusText=$('ul.nav-pills li.active').children('.aIss').find('.spType').text();
	//更新$('.spIssStatus')的text
	$('.spIssStatus').html(statusText);
	
	//每个$('#tblIssList thead a')添加属性
	$('#tblIssList thead a').attr({'href':window.location.hash,'data-title':'点击排序','data-toggle':'tooltip'}).closest('th').addClass('text-center');

	pageShowCom({$searchResultNum});
	buildColumnToggleCom();
	columnToggle();
	sortOrderToggle();
	
	<!-- $('#pDis').html('{$issTest}'); -->
	
})(jQuery);

$(document).ready(function(){
	
	//选择显示/隐藏字段	
	$('#tblIssList ul input').click(function(){
		//复选框点击后的值
		let checkVal=$(this).prop('checked'),val=$(this).val(),
			arr=columnToggleArr;
		if(val=='all'){
			arr.forEach(function(el,index){
				el.showFlag=checkVal;
			});
		}else{
			for(let i=0;i<arr.length;i++){
				if(val==arr[i].val){
					arr[i].showFlag=checkVal;
				}
			}
		}
		//修改columnToggleArr
		columnToggleArr=arr;
		
		columnToggle();	
	});
	<!-- //表格每页显示记录行数 -->
	$('#listRows').val('{$sortData.listRows}'); 
	
	$('#listRows').change(function(){
		var listRows=$(this).val()*1;
		//排序有关的值向$('#divTblSortData')汇集
		if(listRows){
			$('#divTblSortData').data('listRows',listRows);
			//分页从第一页开始
			$('#divTblSortData').data('pageNum',1);
		}
		//调用index.html中的loadAssList()
		loadIssList();
	});	
	//排序
	$('#tblIssList thead a').click(function(){
		let sortName=$(this).data('sortName'),sortOrder=$(this).data('sortOrder');
		//排序有关的值向$('#divTblSortData')汇集
		<!-- if(sortName){ -->
			<!-- $('#divTblSortData').data('sortName',sortName); -->
		<!-- } -->
		<!-- if(sortOrder){ -->
			<!-- $('#divTblSortData').data('sortOrder',sortOrder); -->
		<!-- } -->
		
		$('#divTblSortData').data('sortName',sortName);
		$('#divTblSortData').data('sortOrder',sortOrder);
		$('#divTblSortData').data('pageNum',1);
		//调用index.html中的loadAssList()
		loadIssList();
		
	});	
	
	<!-- // 点击分页中的a，表格中的内容根据a中的属性值进行排序 -->
	$('#divListRows a').click(function(evt){
		// a所在分页页数
		let pageStr=$(this).text(),pageNum,
		//(li.active)所代表的页数
			pageNumActive=$('#divListRows li.active').children('span').text(),
			sortName=$('thead').find('.label').data('sortName');

		evt.preventDefault();
		
		switch(pageStr){
			case'»':
				//用"*"确保得到的是加法运算结果，而不是字符串
				pageNum=(pageNumActive*1+1);
			break;
			
			case'«':
				pageNum=(pageNumActive*1-1);
			break;
			
			default:
				pageNum=pageStr*1;
			break;
		}
		//排序有关的值向$('#divTblSortData')汇集
		if(pageNum){
			$('#divTblSortData').data('pageNum',pageNum);
		}
		//调用index.html中的loadAssList()
		loadIssList();
	});
});

//生成控制显示/隐藏字段的组件
function buildColumnToggleCom(){
	let arr=columnToggleArr;
	//生成单选框组件属性数组
	if(arr.length==0){
		$('#tblIssList').find('th').each(function(){
			<!-- tblColObjArr.push($(this).text()); -->
			let nameEn=$(this).children('a').data('sortName'),
				nameChi=$(this).html();
			<!-- let nameChi=$(this).children('a').html(); -->
			if(nameEn){
				arr.push({'nameChi':nameChi,'val':nameEn,'showFlag':true});
			}else{
				arr.push({'nameChi':nameChi,'val':0,'showFlag':false});
			}
		});
		//附加value="all"的input复选框信息
		arr.push({'nameChi':'全选','val':'all','showFlag':$('#tblIssList ul input').eq(0).prop('checked')});
		//更新组件属性数组
		columnToggleArr=arr;
	}
	//由属性数组生成单选框组件
	arr.forEach(function(el,index){
		let obj=$('#tblIssList');
		let trObj=$('#tblIssList').find('tr');
		//添加col标签
		obj.find('colgroup').append('<col data-col-index="'+index+'">');
			
		//生成显示字段的多选框内容，
		if(el.val && el.val!='all'){
			let labelObj=$('<label></label>').prepend($('<input />').attr({'type':'checkbox','checked':true}).val(el.val)).append($('<span></span>').addClass('text-primary').html(el.nameChi)),
				divObj=$('<div></div>').append(labelObj).addClass('checkbox');
			obj.find('ul').append($('<li></li>').append(divObj));
		}
		//每个th、td添加data-hide-val=""，相同的data-hide-val=""用于组合成一个col
		trObj.each(function(){
			if(el.val){
				$(this).children().eq(index).attr('data-hide-val',el.val);
			}
		});	
	});
	
	//对生成的控制显示隐藏字段的单选框格式进行微调
	$('#tblIssList caption div.checkbox').css('padding-left','10px').find('input').css('margin-top','0');	
};

</script>

