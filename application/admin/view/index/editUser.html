<!-- editUser.html -->
	
<form id="fmUser" role="form" action="{$home}/admin/index/userOprt"  method="post">
	<input id="id" type="text" name="id" value="{$user.id}" class="sr-only">
	<input id="oprt" type="text" name="oprt" value="{$oprt}" class="sr-only">
	<div class="row">
	<div class="form-group has-feedback col-sm-6">
		<label for="username">用户名<span class="small glyphicon glyphicon-asterisk text-danger"></span></label>
		<!-- // bootstrap实现矢量图在输入框开头 -->
		<div class="input-group">
			<span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
			<input type="text" class="form-control inputCheck" id="userName" name="userName" value="{$user.username}" placeholder="输入用户名">	
		</div>
					
		<!-- // 配合jQuery 中的内容验证代码-->
		<span style="color:red;display:none;" class="spTips"></span>
        <span style="display: none;margin-right:17px;" class="spRemove glyphicon glyphicon-remove form-control-feedback"></span>
        <span style="display: none;margin-right:17px;" class="spOk glyphicon glyphicon-ok form-control-feedback"></span>	
	</div>
	
	<div class="form-group col-sm-6">
		<label for="psw">登录密码<span class="small text-danger">（用户需登录后自己修改）</span></label>
		<!-- // bootstrap实现矢量图在输入框开头 -->
		<div class="input-group">
			<span class="input-group-addon"><span class="small glyphicon glyphicon-th-large"></span></span>
			<input type="password" class="form-control" id="pwd" name="pwd" readonly="true" autocomplete="pwd" placeholder="系统默认为‘111111a’">
		</div>		
		
	</div>
	
	</div>
	
	<div class="row">
	<div class="form-group has-feedback col-sm-6">
		<label for="userMobile">手机号<span class="small glyphicon glyphicon-asterisk text-danger"></span></label>
		<!-- // bootstrap实现矢量图在输入框开头 -->
		<div class="input-group">
			<span class="input-group-addon"><span class="glyphicon glyphicon-phone"></span></span>
			<input type="text" class="form-control inputCheck" id="userMobile" name="mobile" value="{$userMobile}" placeholder="输入用户手机号">	
			
		</div>
					
		<!-- // 配合jQuery 中的内容验证代码-->
		<span style="color:red;display:none;" class="spTips"></span>
        <span style="display: none;margin-right:17px;" class="spRemove glyphicon glyphicon-remove form-control-feedback"></span>
        <span style="display: none;margin-right:17px;" class="spOk glyphicon glyphicon-ok form-control-feedback"></span>	
	</div>
	
	<div class="form-group has-feedback col-sm-6">
		<label for="selDept">选择部门<span class="small glyphicon glyphicon-asterisk text-danger">（单选）</span></label>
		<div class="input-group">
			<span class="input-group-addon"><span class="glyphicon glyphicon-tree-conifer"></span></span>
			<select class="form-control inputCheck" id="selDept" name="dept">
    			<option value="0">……选择一个部门</option>
    		</select>
		</div>
		<span style="color:red;display:none;" class="spTips"></span>
        <span style="display: none;margin-right:34px;" class="spRemove glyphicon glyphicon-remove form-control-feedback"></span>
        <span style="display: none;margin-right:34px;" class="spOk glyphicon glyphicon-ok form-control-feedback"></span>
	</div>
	</div>	
	
	<div class="row">
	<div class="form-group col-sm-6">
		<label for="selUsergroup">可加入用户组数：<span class="spNum"></span><span class="small text-primary">（单击加入）</span></label>
		<div class="input-group">
			<span class="input-group-addon"><span class="glyphicon glyphicon-plus"></span></span>
			<select class="form-control" id="selUsergroup">
    			
    		</select>
		</div>
	</div>
	
	<div class="form-group has-feedback col-sm-6">
		<label for="selectedUsergroup">已加入用户组数：<span class="spNum text-danger"></span>&nbsp;<span class="small  glyphicon glyphicon-asterisk text-danger">（单击退出）</span></label>
		<div class="input-group">
			<span class="input-group-addon"><span class="glyphicon glyphicon-education"></span></span>
			<select class="form-control inputCheck" id="selectedUsergroup">
    			
    		</select>
		</div>
		
		<span style="color:red;display:none;" class="spTips"></span>
        <span style="display: none;margin-right:34px;" class="spRemove glyphicon glyphicon-remove form-control-feedback"></span>
        <span style="display: none;margin-right:34px;" class="spOk glyphicon glyphicon-ok form-control-feedback"></span>
		
	</div>
	</div>	
				
	<div class="myFieldset form-group">
		<div class="myLegend">
		<!-- <span id="spUserEn" class="spUserEn"><span class="glyphicon glyphicon-magnet"></span>&nbsp;用户启用</span> -->
		<span class="label label-info glyphicon glyphicon-magnet">用户启用</span>
		
			<!-- <label class="" for="usergroupEn">用户组启用</label> -->
			<label class="radio-inline">
      			<input type="radio" name="userEn" value="1" checked><span class="label label-info">是</span>
    		</label>
    		<label class="radio-inline">
      			<input type="radio" name="userEn" value="0" ><span class="label label-default">否</span>
    		</label>
		</div>
	</div>
	<!-- <div class="checkbox">
				  <label><input type="checkbox" value="" checked>Remember me</label>
				</div> -->
	<hr>
	<button id="btnCreate" type="submit" class="btn btn-primary btn-sm" data-oprt="_CREATE"><span class="glyphicon glyphicon-file"></span>&nbsp;新增</button>
	
	<button id="btnUpdate" type="submit" class="btn btn-primary btn-sm" data-oprt="_UPDATE"><span class="glyphicon glyphicon-ok"></span>&nbsp;保存</button>
		
	<button id="btnDelete" type="submit" class="btn btn-danger btn-sm" data-oprt="_DELETE"><span class="glyphicon glyphicon-remove"></span>删除</button>
	
	<div class="pull-right">	
		<button id="btnFormReset" type="reset" class="btn btn-primary btn-sm">重置</button>
				
		<button type="button" class="btn btn-warning btn-sm" data-dismiss="modal">取消</button>
	</div>
</form>

<script>

$(document).ready(function(){

//userName正则表达式，由英文、数字、中文和下划线组成,但不能以数字开头,长度为2到20个字符。unicode编码中的汉字范围:\u2E80-\u9FFF
	var regUsername = /^[a-zA-Z_\u2E80-\u9FFF][a-zA-Z0-9_\u2E80-\u9FFF]{1,19}$/;
	
//mobile正则表达式，11位数字。必须以1开头。
	var regMobile = /^1[0-9]{10}$/;
		
	<!-- // 单选框#selDept的内容 -->
	ajaxSelectOption($('#selDept'),{"async":false,"url":"selectResponse","ajaxData":{"req":"_DEPT"},"first":{"val":"0","text":"请选择一个部门…"},"selected":{"val":"{$user.dept}"}});
	// 得到页面加载时单选框#selUsergroup的option内容，页面“重置”时加载
	var selUsergroupStr=ajaxSelectOption($('#selUsergroup'),{"async":false,"url":"selectResponse","ajaxData":{"req":"_USERGROUP"},"first":{"val":"0","text":"可选…"},"remove":{"val":"{$user->get('usergroup_id')}"}});
	// 保留页面加载时单选框#selUsergroup的label内容，页面“重置”时加载
	var spNumSelUsergroup=$('#selUsergroup').closest('.form-group').find('.spNum').text();
	// 得到页面加载时单选框#selectedUsergroup的option内容，页面“重置”时加载
	var selectedUsergroupStr=ajaxSelectOption($('#selectedUsergroup'),{"async":false,"url":"selectResponse","ajaxData":{"req":"_USERGROUP"},"first":{"val":"0","text":"已加入…"},"show":{"val":"{$user->get('usergroup_id')}"},"selected":0,"multiple":0});
	// 保留页面加载时单选框#selectedUsergroup的label内容，页面“重置”时加载
	var spNumSelectedUsergroup=$('#selectedUsergroup').closest('.form-group').find('.spNum').text();
	//必填输入框内容有效性判断结果数组
	var check = [];
	
	$('.inputCheck').each(function(){
		var i=$('.inputCheck').index($(this));
		//‘新增’时{$user.id}==0，
		if({$user.id}==0){
			check[i]=false;
		}else{
			//有效性判断结果
			check[i]=inputCheck($(this));
		}
		<!-- console.log(check[i]); -->
	});
	
	$('#selUsergroup').change(function(){
		selOptionChange($(this),$('#selectedUsergroup'));
		// 输入内容有效性判断，#selectedUsergroup
		check[$('.inputCheck').index($('#selectedUsergroup'))]=inputCheck($('#selectedUsergroup'));
	});
	
	$('#selectedUsergroup').change(function(){
		selOptionChange($(this),$('#selUsergroup'));
	});
	
	// 输入内容有效性判断，#userName
	$('#userName').focusout(function() { 
		check[$('.inputCheck').index($(this))]=inputCheck($(this));
		$('#pwd').val('111111a');
	});
	
	//输入内容有效性判断,#userMobile
	$('#userMobile').focusout(function(){
		check[$('.inputCheck').index($(this))]=inputCheck($(this));
	});
	
	//输入内容有效性判断,#selectedUsergroup
	$('#selDept').focusout(function(){
		check[$('.inputCheck').index($(this))]=inputCheck($(this));
	});
	
	//输入内容有效性判断,#selectedUsergroup
	$('#selectedUsergroup').focusout(function(){
		check[$('.inputCheck').index($(this))]=inputCheck($(this));
	});
	
	//button:submit按钮
	$('button:submit').click(function(event){
		var url='userOprt';
		var name=$('#userName').val();
		var oprt=$(this).attr('data-oprt');
		var formData=new FormData($('#fmUser').get(0));
		var anchor=window.location.hash;
		var strHtml=$(this).html();
		var selectedUsergroup=$('#selectedUsergroup').find('option:last').val();
		var flag=check.every(function(value) {
            return value == true
        });
		//组装usergroup_id字符串的函数
		var usergroupIdStr=function(obj){
  			var str='';
			var arr=[];
  			if(obj.find('option:last').val()){
    			for (var i=1;i<obj.find('option').length;i++){
      				str+=obj.find('option').eq(i).val()+',';
					arr.push(obj.find('option').eq(i).val());
    			}
  			}else{
    			str=obj.find('option:last').val();
				arr.push(obj.find('option:last').val());
  			}
			//数组arr的内容转成‘,’分隔的字符串
			str=arr.join(',');			
  			return str;
		};
		
		//阻止表单提交动作
		event.preventDefault();
		
		formData.append('oprt',oprt);
		formData.append('usergroup_id',usergroupIdStr($('#selectedUsergroup')));
		if(oprt=='_DELETE'){
			strHtml='<span class="label label-danger">'+strHtml+'</span>';
		}else{
			strHtml='<span class="label label-primary">'+strHtml+'</span>';
		}
		if (!flag && oprt!='_DELETE') {
			var arr=[];
			<!-- //check中存在false,对应的input用“has-error”突出显示。 -->
        	for (key in check) {
            	if(!check[key]){
                	$(this).closest('form').find('.has-feedback').eq(key).removeClass('has-success').addClass('has-error');
					arr.push(key);
            	}
        	}
			//序号最小的$('.inputCheck').eq(i)获得焦点
			$('.inputCheck').eq(Math.min.apply(null, arr)).focus();	
		}else{
			$('.modal').modal('hide');
			$.confirm(strHtml+'【'+name+'】',function(e){
				con=e;
				if(true==con){
					ajaxProcess(url,formData,anchor);
				}
				else{
					$('.modal').modal('show');
				}
			}).ok('确定(Y)').cancel('取消(N)');		
		}
	});
	
	// 表单input:radio选中元素改变标题span背景色
	$('input:radio').change(function(){
		if($(this).val()==1){
			$(this).closest('div').children('span').addClass('label label-info');
		}else{
			$(this).closest('div').children('span').removeClass('label label-info');
		}
	});
	
	$('#btnFormReset').click(function(event) {
		//阻止表单reset
		event.preventDefault();
		//本按钮所在form进行reset
		$(this).closest('form').get(0).reset();
		
		$('.has-feedback').removeClass('has-success').removeClass('has-error'); 
		$('.spTips').hide();
    	$('.spOk').hide();
    	$('.spRemove').hide();
		
		$('.inputCheck').eq(0).focus();
		
		$('input:radio').closest('div').children('span').addClass('label label-info');
		//#selUsergroup的option、.spNum内容恢复到页面加载时的内容
		$('#selUsergroup').html(selUsergroupStr).closest('.form-group').find('.spNum').text(spNumSelUsergroup);
		//#selectedUsergroup的option、label内容恢复到页面加载时的内容
		$('#selectedUsergroup').html(selectedUsergroupStr).closest('.form-group').find('.spNum').text(spNumSelectedUsergroup);
	
	});

//校验成功函数，返回true
function success(obj) {
    var divParent=obj.closest('.has-feedback');
	divParent.removeClass('has-error').addClass('has-success');
	divParent.children('span').hide();
	divParent.children('.spOk').show();
    return true;
}

// 校验失败函数，返回false
function fail(obj,msg) {
    var divParent=obj.closest('.has-feedback');
	divParent.removeClass('has-success').addClass('has-error');
	divParent.children('span').hide();
	divParent.children('.spTips').text(msg).show();
    divParent.children('.spRemove').show();
	return false;
}

//**函数名：ajaxProcess
 	//* 作用：本页面ajax过程
	//* 参数url，类型：字符串。值：不为空。说明：ajax操作的URL。
	//* 参数data，类型：数值。值：传送给后端的键值对数据。
	//* 参数archor，类型：字符串。值：本页面锚点值：window.location.hash。
	//* 返回值：无
function ajaxProcess(url,data,archor){
	$.ajax({
		type: 'post',
        url: url,
        data: data,
		timeout:2000,
		<!-- datatype: 'JSON', -->
        contentType: false,// 当有文件要上传时，此项是必须的，否则会导致后台无法识别文件流的起始位置
        processData: false,// 是否序列化data属性，默认true(注意：false时type必须是post)。当使用FormData()，必须设为false，否则jqurey默认将FormData()转换为查询字符串。
		success: function(dataBack){
			<!-- $('.modal').modal('hide'); -->
			//dataBack的5个返回值id,result,name,msg,msgPatch
			if(dataBack.result=='success'){
				//ajax更新页面信息
				$('#content').load(
					'tplFile',
					{'sId':archor},
					function(){
						//所在行上色'bg-warning'
						$('button[data-id="'+dataBack.id+'"]').closest('tr').addClass('bg-warning').focus();
						$.alert('用户【'+dataBack.name+'】<span class="label label-success">'+dataBack.msg+'</span><br>'+dataBack.msgPatch);
					}
				);
			}else{
				$.alert('用户【'+dataBack.name+'】<span class="label label-danger">'+dataBack.msg+'</span><br>'+dataBack.msgPatch);	
			}
		},
		error: function(){
			$.alert('与服务器通讯超时，请稍后再试！');
		}
	});	
}

//**函数名：ajaxSelectOption
 	//* 作用：本页面ajax过程向服务器请求特定单选框内容所需数据，并组装好HTML语句
	//* 参数obj，类型：对象。值：不为空。说明：调用函数的对象。
	//* 参数param，类型：json。值：param={"async":true,"url":"selectResponse","ajdxdata":{"req":"_DEPT"},"first":{"val":"0","text":"t"},"show":{"val":"1,2,3","text":"t"},"remove":{"val":"v","text":"t"},"selected":{"val":"v","text":"t"},'multiple':0}
	//*param.async,类型：Boolean。值：必须。说明：函数同步/异步操作。	
	//*param.url,类型：字符串。值：必须。说明：函数中ajax操作的URL。	//*param.ajaxdata,类型：json。值：必须。说明：函数中ajax传送的data。	//*param.first,类型：json。值：默认为{"val":"0","text":"第一项"}。说明：调用函数后创建的第一项option的val值（字符串），text值（字符串）。
	//*param.show,类型：json。值：默认为0。说明：调用函数后需要的option项val值字符串，text字符串。
	//*param.remove,类型：json。值：默认为0。说明：调用函数后要不需要的option项val值字符串，text字符串。
	//*param.selected,类型：json。值：默认为0。说明：调用函数后选定的option项val值字符串，text字符串。
	//*param.multiple,类型：boolean。值：默认为0。说明：调用函数后obj是否为单选框，默认为单选框。
	//* 返回值：optionHtml
function ajaxSelectOption(obj,param){
	var defaultParam={"async":true,"url":0,"ajaxData":0,"first":{"val":0,"text":"first"},"show":0,"remove":0,"selected":0,'multiple':0};
    param=$.extend({},defaultParam,param); 
    var str='';
	var optionHtml='';
	$.ajax({
		type : 'post',
		async : param.async,  //true:异步请求，false：同步请求
		url : param.url,
		data : param.ajaxData,
		timeout:2000,
		<!-- // 指定服务器端response的数据类型为json-->
		dataType:'json',
		success:function(backData){
			var str='<option value="'+param.first.val+'">'+param.first.text+'</option>';
			<!-- // 遍历backData数组组装HTML语句 -->
			<!-- // backData的结构是数组类的：[{id:1,name:"dept1", abbr:"d1"},{}],所以要进行嵌套取出id，name和abbr的值组装HTML语句-->
			$.each(backData,function(n1,v1){
				var i=0;
				$.each(v1,function(n2,v2){
					//根据data的内容安排backData
					switch(param.ajaxData.req){
						case '_DEPT':
							if(n2=='name'){
								str+='<option value="'+v2+'">'+v2+' （简称：';
							}
							if(n2=='abbr'){
								str+=v2+'）</option>';
							}
						break;
						
						case '_USERGROUP':
							if(n2=='id'){
								str+='<option value="'+v2+'">';
							}
							if(n2=='name'){
								str+=v2+'</option>';
							}
						break;	
					}
					i++;
				});
			});
			obj.empty();
			obj.append(str);
			
			//showSelectOption
			if(param.multiple==1){
        		obj.attr('multiple',true);
    		}else{
				obj.attr('multiple',false);
			}
			if(param.show!=0){
        		obj.find('option').each(function(){
					if(param.show.val.split(',').indexOf($(this).val())==-1 && $(this).val()!=0){
            			$(this).remove();
        			}	
    			});
				obj.closest('.form-group').find('.spNum').text(obj.find('option').length-1);
    		}
			if(param.remove!=0){
				obj.find('option').each(function(){
					if(param.remove.val.split(',').indexOf($(this).val())!=-1 && $(this).val()!=0){
            			$(this).remove();
        			}	
    			});
				obj.closest('.form-group').find('.spNum').text(obj.find('option').length-1);
    		}
    		if(param.selected==0){
        		//第一项为选中项
				obj.find('option:first').attr('selected','selected');
    		}else{
				//param.selected.val是option的value值字符串，设定值在param.selected.val中的option为选定项
				obj.find('option').each(function(){
	    			if(param.selected.val.indexOf($(this).val())!==-1){
                		$(this).attr('selected',true);
            		}else{
                		$(this).attr('selected',false);
           			}
				});	
    		}
			
			optionHtml=obj.html();
		},
		error: function() {
            $.alert('与服务器通讯超时，请稍后再试！');
        }
	});
	//同步就返回值rt
	if(param.async==false){
		return optionHtml;
	}
}

//**函数名：selOptionChange
 	//* 作用：本页面内2个<select>级联。一个减少的option是另一个增加的。
	//* 参数obj，类型：对象。值：不为空。说明：调用函数的select。
	//* 参数partner，类型：对象。值：不为空。说明：调用函数的select的搭档。
	
	//* 返回值：无
function selOptionChange(obj,partner){
	var str='';
	//兼容multiple=1
	obj.find('option:selected').each(function(){
		str+='<option value="'+$(this).val()+'">'+$(this).text()+'</option>';
		$(this).remove();
    });
	obj.closest('.form-group').find('.spNum').text(obj.children('option').length-1);
	//对partner的操作
	partner.append(str);
	partner.closest('.form-group').find('.spNum').text(partner.children('option').length-1);
}

//**函数名：inputCheck
 	//* 作用：本页面必填输入框内容有效性判断
	//* 参数obj，类型：对象。值：不为空。说明：调用函数的对象。
	//* 返回值：boolean
function inputCheck(obj){
	var idName=obj.attr('id');
	var i=$('.inputCheck').index(obj);
	var result=false;
	switch(idName){
		case 'userName':
			if (regUsername.test(obj.val())) {
        		result=success(obj);
    		} else if (obj.val().length < 2) {
        		fail(obj,'有'+obj.val().length+'个字符，不能少于2个字符。');
    		} else {
        		fail(obj,'可由英文、数字、中文和下划线组成，但不能以数字开头。')
    		}
		break;
		case 'userMobile':
			var len=obj.val().length;
			if (regMobile.test(obj.val())) {
        		result=success(obj);
    		} else if (len< 11) {
        		fail(obj, '只有'+len+'位。手机号是11位数字，必须以1开头。');
    		} else if (len > 11) {
        		fail(obj,'有'+len+'位，手机号由1开头的11位数字组成。');
    		}else {
        		fail(obj,'已有'+len+'位，但必须是以1开头的11位数字')
    		}
		break;
		case 'selDept':
			if(obj.val()==0){
				fail(obj,'请选择一个部门');
			}else{
				result=success(obj);
			}
		break;
		case 'selectedUsergroup':
			if(obj.find('option:last').val()==0){
				fail(obj,'至少有一个用户组');
			}else{
				result=success(obj);
			}
		break;
		
	}
	return result;
}

<!--/ function -->
	
});

</script>


