<!-- //userSinglForm.html -->
<form id="fmUser1" role="form" action="" method="post">
	<div class="sr-only">
		<input name="id" value="{$userSet.id}">
		<input name="oprt" value="{$oprt}">
	</div>
	<div class="myFieldset">
		<div class="myLegend"><span class="label label-info"><span class="glyphicon glyphicon-duplicate"></span>&nbsp;用户信息</span></div>
		<div id="formGroupCom" class="row myRow">
			
		</div>
				
		<a style="padding-left:10px;font-size:16px;" data-toggle="collapse" href="#divUserAuth" title="显示/隐藏系统权限">用户系统模块权限...</a>
		<p><p/>
		<p id="authRank" style="padding-left:20px;"></p>
		<div id="divUserAuth" class="row myRow collapse" style="margin-top:10px;">
			<span class="label label-default" style="margin-left:40px;font-size:100%">无</span>
		</div>	
	
		<hr>
		<!-- 空白行 -->
		<p>   <p/>
		
		<div class="myLegend">
			<br/>
			<span class="label label-default">
			<span class="glyphicon glyphicon-magnet"></span>&nbsp;用户启用
			</span>&nbsp;&nbsp;&nbsp;&nbsp;
			
			<span id="radioCom"></span>
			<!-- //js中radioCom的建模参考 -->
			<!-- <label class="radio-inline"> -->
      			<!-- <input type="radio" name="usergroupEn" value="1" checked><span class="label label-success">是</span> -->
    		<!-- </label> -->
    		<!-- <label class="radio-inline"> -->
      			<!-- <input type="radio" name="usergroupEn" value="0" ><span class="label label-default">否</span> -->
    		<!-- </label> -->
		</div>
		<hr>
	
		<div class="row myRow">	
			<div id="oprtBtnCom" class="pull-left"></div>
	
			<div class="pull-right">
				<input type="reset" class="btn btn-primary btn-sm" value="重置">
				<input type="button" class="btn btn-warning btn-sm" data-dismiss="modal" value="取消">
			</div>
			
		</div>			
	</div>
	</form>

	
<script>
var userSet={$userSet},
	oprt='{$oprt}',
	fm=$('#fmUser1');

//生成radio组件。
var buildRaCom=(node)=>{
	let labSet=[],
		spHelp=$('<span></span>').addClass('help-block').css('color','red');
	node.empty();	
	//生成radio组件
	for(var i=0;i<2;i++){
		let inObj=$('<input>').attr({type:'radio',name:'userEn',value:i}),
			spObj=$('<span></span>').addClass('label label-default');		
		i?spObj.text('是'):spObj.text('否');
		labSet[i]=$('<label></label>').addClass('control-label radio-inline').append(inObj,spObj);
	}
	if(userSet.enable){
		labSet[1].children('input').attr('checked',true);
		labSet[1].children('span').addClass('label-success');
		$('#radioCom').siblings('.label').addClass('label-info');
	}else{
		labSet[0].children('input').attr('checked',true);
	}
	node.append(labSet);
};
//完善操作按钮
var oprtBtnComShow=(node,oprt)=>{
	let uBtn='',
		oBtn='';
	let buildBtn=(oprt)=>{
			let e=oprtBtnProp[oprt],
				sBtn=$('<button></button>').addClass('btn btn-sm btnOprt').attr({'type':'submit','data-oprt':oprt});
			sBtn.addClass(e.color.btn).html(e.glyCom+e.chi);
			return sBtn;
		};
	node.empty();
	switch(oprt){
		case '_CREATE':
			oBtn=buildBtn(oprt);
			break;
		case '_DELETE':
			uBtn=buildBtn('_UPDATE');
			oBtn=buildBtn(oprt);
			break;
		case '_EDIT':
			oBtn=buildBtn('_UPDATE');
			break;
	}		
	node.append(uBtn,'&nbsp;',oBtn);
};
//设置input:radio元素及其关联组件的背景色，适用于有2个radio
var radioBg=(node='null')=>{	
	let rObj=(node=='null')?$('#radioCom'):node,
		lObj=rObj.siblings('.label'),
		yR=rObj.find('[value="1"]'),
		labS='label-success',
		labI='label-info';
	
	if(yR.prop('checked')==true){
		yR.next().addClass(labS);
		lObj.addClass(labI);
	}else{
		yR.next().removeClass(labS);
		lObj.removeClass(labI);
	}
};

//生成auth的显示组件。根据查询到的auth数据uSet.authority，参照已定义的authEntProp变量
var buildAuthCom=(uAuth='')=>{
	let rSet={},
		num={},	
		//循环计数器
		m=0
		colNod=$('#divUserAuth'),
		tagNod=$('#authRank');
	//定义权限涉及的颜色属性，权限重要性分类
	let authColor={
		common:{bs3:bs3Color.success,chi:'普通'},
		important:{bs3:bs3Color.warning,chi:'重要'},
		critical:{bs3:bs3Color.danger,chi:'关键'}
	};
	
	if(typeof uAuth != 'object'){
		colNod.empty().append('<span class="label label-default" style="margin-left:40px;font-size:100%">无</span>');
		if(colNod.hasClass('in')){
			<!-- colNod.removeClass('in'); -->
			colNod.collapse();
		}
		tagNod.empty();
		return ;	
	}
	
	//按权限类别赋初值
	Object.keys(authColor).forEach(function(el){
		rSet[el]=[];
		num[el]=0;
	});	
	//生成各项auth的组件，遍历hash数组：uAuth
	//ent=='admin'...
	for(var ent in uAuth){
 		let authObj=uAuth[ent],
			name=authEntProp[ent]['chi'],
			sumAuth=0,
			//循环计数器
			i=0,
			spSet=[], 
			rank=authEntProp[ent]['rank'],
		    //父标签底色类型
			bgColor=authColor[rank]['bs3']['lab'],
			//标签背景色
			txtColor=authColor[rank]['bs3']['txt'],
			rCom=$('<div></div>').addClass('form-group col-sm-6'),
			c1=$('<label></label>').addClass('control-label '+bgColor).html(name).css({'padding':'3px 5px','border-radius':'3px','font-size':'14px'}),
			c2=$('<div></div>').css({'padding':'5px 20px','border-bottom':'solid 1px #ccc'});
		
		//遍历hash数组：authObj，
		//auth=='read'...
		for(var auth in authObj){
			let e=authEntProp[ent]['auth'][auth],
				v=authObj[auth],
				chi=$('<strong></strong>').text(e.chi),
				spCom=$('<span></span>').addClass(txtColor).append(chi,'&nbsp;');
			
			if(v){
				//生成单个权限组件
				spSet[i]=$('<span></span>').append(spCom,'&nbsp;&nbsp;'	); 
				//单个模块权限总数
				i++;
			}
		}
		if(i){
			c2.append(spSet);
			rSet[rank][m]=rCom.append(c1,c2);
			//有权限的模块总数
			m++;
			//rank类模块的总数
			num[rank]++;
		}
	}
	
	if(m){
		tagNod.empty().append('<strong>系统模块类别：</strong>&nbsp;');
		colNod.empty(); 
		<!-- if(colNod.attr('class').indexOf('in')==-1){ -->
		if(!colNod.hasClass('in')){
			colNod.collapse('show');
		}
	
	}

	//生成#authRank的内容
	for(let el in num){
		let e=authColor[el],
			spObj=$('<span></span>').css({'padding':'3px 5px','border-radius':'3px','font-size':'12px'});	
		//生成权限类别标签	
		if(num[el]){
			tagNod.append('&nbsp;',spObj.addClass(e.bs3.lab).text(e.chi));
		}
		//权限按模块分类显示
		colNod.append(rSet[el]);
	}
	return;
};

var	buildFormGroupCom=(node)=>{
	let glyRisk='<span class="glyphicon glyphicon-asterisk"></span>',
		//与后端传送的字段名保持一致
		formGoupComProp={
			//r1
			username:{rCss:'has-feedback',c1CColor:'text-danger',c1CGly:glyRisk,c1CTxt:'',c1Txt:'用户名',c2C1Gly:'<span class="glyphicon glyphicon-user"></span>',c2C2Type:'input',c2C2Css:'inputCheck',c2C2Attr:{'name':'username','value':'','placeholder':'输入用户名','type':'text'}},
			//r2
			pwd:{rCss:'',c1CColor:'text-danger',c1CGly:'',c1CTxt:'（用户需登录后自己修改）',c1Txt:'登录密码',c2C1Gly:'<span class="glyphicon glyphicon-th-large"></span>',c2C2Type:'input',c2C2Css:'',c2C2Attr:{'placeholder':'系统默认为‘111111a’','value':'','readonly':true}},
			//r3
			mobile:{rCss:'has-feedback',c1CColor:'text-danger',c1CGly:glyRisk,c1CTxt:'',c1Txt:'手机号',c2C1Gly:'<span class="glyphicon glyphicon-phone"></span>',c2C2Type:'input',c2C2Css:'inputCheck',c2C2Attr:{'name':'mobile','value':'','placeholder':'输入用户手机号','type':'text'}},
			//r4
			dept:{rCss:'has-feedback',c1CColor:'text-danger',c1CGly:glyRisk,c1CTxt:'（单选）',c1Txt:'选择部门',c2C1Gly:'<span class="glyphicon glyphicon-tree-conifer"></span>',c2C2Type:'select',c2C2Css:'inputCheck',c2C2Attr:{'name':'dept'}},
			//r5
			toJoinGroup:{rCss:'',c1CColor:'text-primary',c1CGly:'',c1CTxt:'（单击加入）',c1Txt:'可加入用户组',c2C1Gly:'<span class="glyphicon glyphicon-plus"></span>',c2C2Type:'select',c2C2Css:'',c2C2Attr:{'name':'toJoinGroup'}},
			//r6
			joinedGroup:{rCss:'has-feedback',c1CColor:'text-danger',c1CGly:glyRisk,c1CTxt:'（单击退出）',c1Txt:'已加入用户组',c2C1Gly:'<span class="glyphicon glyphicon-education"></span>',c2C2Type:'select',c2C2Css:'inputCheck',c2C2Attr:{'name':'joinedGroup'}}
		},
		//formDiv计数器，上限<formGoupComProp.length
		m=0
		formDiv=[],
		rowDiv=[];

	for(var ent in formGoupComProp){
		let e=formGoupComProp[ent],
			valBe=userSet[ent],
			rObj=$('<div></div>').addClass('form-group col-sm-6 '+e.rCss),
			c1C=$('<span></span>').addClass('small '+e.c1CColor).append(e.c1CGly,e.c1CTxt),
			c1=$('<label></label>').addClass('control-label'),
			c2C1=$('<span></span>').addClass('input-group-addon').append(e.c2C1Gly),
			sel=$('<select></select>').addClass('form-control'),
			inp=$('<input/>').addClass('form-control'),
			c2C2='',
			c2=$('<div></div>').addClass('input-group'),
			//.inputCheck后添加span，配合jQuery中的内容验证代码
			c3='<span style="color:red;display:none;" class="spTips"></span><span style="display: none;margin-right:34px;" class="spRemove glyphicon glyphicon-remove form-control-feedback"></span><span style="display: none;margin-right:34px;" class="spOk glyphicon glyphicon-ok form-control-feedback"></span>';
		
		c1.append(e.c1Txt,c1C);

		if(e.c2C2Type=='input'){
			e.c2C2Attr.value=valBe;
			c2C2=inp.attr(e.c2C2Attr);
		}
	
		if(e.c2C2Type=='select'){
			//若ent=='dept'，组装select组件时，valBe是字符串，
			//要通过hash数组userSet.allDept来组装option。
			//不然valBe就是hash数组
			let arr=(ent=='dept')?userSet['allDept']:valBe,
				//选定option项的值
				selVal=0;
			
			Object.entries(arr).forEach(function(v,k){
				//组装option
				sel.append($('<option></option>').val(v[0]).text(v[1]));
				
				if(ent=='dept' && valBe==v[1]){
					selVal=v[0];
				}
				
			});
			//设定选定项
			if(ent=='dept'){
				sel.val(selVal);
			}else{
				<!-- //计算总数，添加第一项总数项并设为选定项 -->
				<!-- sel.prepend($('<option></option>').val(0).text('...总数：'+sel.children().length).prop('selected',true)); -->
				//计算总数，添加第一项总数项并设为选定项
				sel.prepend($('<option></option>').val(0).text('...总数：'+sel.children().length).attr('selected',true));
			}
			c2C2=sel.attr(e.c2C2Attr);
		}
		c2.append(c2C1,c2C2.addClass(e.c2C2Css));
		(e.c2C2Css)?rObj.append(c1,c2,c3):rObj.append(c1,c2);
		formDiv[m]=rObj;
		m++;
	}
	if(oprt!='_CREATE'){
		//第二个formDiv组件就是pwd，非_CREATE操作不需要
		formDiv[1].empty();
	}
	
	for(var i=0;i<formDiv.length;i++){
		//2个formDiv一组装入rowDiv中
		rowDiv[i]=$('<div></div>').addClass('row myRow').append(formDiv[i*2],formDiv[i*2+1]);
	}
	//rowDiv放入node
	node.empty().append(rowDiv);
	
};
//相互关联的2个select的内容变化
var selOptionChange=(obj,ptObj)=>{
	let str='',num=0;
	let joinedId=[];
	let joinedNod=fm.find('[name="joinedGroup"]');
	//兼容multiple=1
	obj.find('option:selected').each(function(){
		if($(this).val()!=0){
			str+='<option value="'+$(this).val()+'">'+$(this).text()+'</option>';
			$(this).remove();
			num++;
		}
    });
	
	if(num){
		obj.find('option:first').text('...总数：'+(obj.children('option').length-1));
		//对partner的操作
		ptObj.append(str);
		ptObj.find('option:first').text('...总数：'+(ptObj.children('option').length-1));
	}
};

var getJoinedGroupStr=()=>{
	let arr=[];
	fm.find('[name="joinedGroup"]').children('option').each(function(index,e){
		(e.value==0)?'':arr.push(e.value);
	});
				
	return arr.sort(function(a,b){return a-b;}).join(',');
};

var ajaxBuildAuthCom=()=>{
	let idStr=getJoinedGroupStr();
	
	if(!idStr.length){
		return buildAuthCom();
	}
	
	$.post('calculateUserAuth',{joinedGroupId:idStr},function(uAuth){
		if(uAuth){
			buildAuthCom(uAuth);
		}
	});
	
};

//自调用匿名函数立即执行的特点，进行页面初始化。
;(function($){	
	buildRaCom($('#radioCom'));
	oprtBtnComShow($('#oprtBtnCom'),oprt);	
	buildFormGroupCom($('#formGroupCom'));
	
	ajaxBuildAuthCom();

	fm.find('.myFieldset').css('border-width','0px');
	<!-- initFm(); -->
	// 激活tooltip
	$('[title]').tooltip();   
})(jQuery);

$(document).ready(function(){
	
// 初始化数组，存储表单中输入框（class="inputCheck"）的内容验证结果“true/false”。数组下标应与输入框下标一致，便于编程选择输入框
	var check = Array(fm.find('.inputCheck').length).fill(false);
	<!-- //username内容验证 -->
	<!-- fm.find('[name="username"]').focusout(function(){ -->
 		<!-- inputValid($(this)); -->
  	<!-- }); -->
	<!-- //mobile内容验证 -->
	fm.find('[name="mobile"]').focusout(function(){
        let url='userOprt',
			oprt='_READ',
			mobile=$(this).val(),
			//定义回调函数
			cbFn=(txt)=>{
				return inputValid($(this),txt);
			};
		formData=new FormData();
		formData.append('id',fm.find('[name="id"]').val());
		formData.append('mobile',mobile);
		formData.append('oprt',oprt);
		//检查mobile是否唯一
		ajaxUgoprt(url,formData,cbFn);

  	});
	//dept内容验证
	<!-- fm.find('[name="dept"]').focusout(function(){ -->
 		<!-- inputValid($(this)); -->
  	<!-- }); -->
	//joinedGroup内容验证
	<!-- fm.find('[name="joinedGroup"]').focusout(function(){ -->
 		<!-- inputValid($(this)); -->
  	<!-- }); -->
	
	//表单select,[name="toJoinGroup"]
	fm.find('[name="toJoinGroup"]').change(function(){
		selOptionChange($(this),fm.find('[name="joinedGroup"]'));
		ajaxBuildAuthCom();
	});
	
	//表单select,[name="toJoinGroup"]
	fm.find('[name="joinedGroup"]').change(function(){
		selOptionChange($(this),fm.find('[name="toJoinGroup"]'));
		ajaxBuildAuthCom();
	});
	
	// 表单input:radio选中元素改变背景色
	fm.find('input:radio').change(function(){
		radioBg();
	});
	
	//表单提交按钮按下时修改oprt
	fm.find('button:submit').click(function(){
		fm.find('[name="oprt"]').val($(this).data('oprt'));
	});
	//表单提交
	fm.submit(function(evt){
		let url='userOprt',
			inSet=$(this).find('.inputCheck');
			name=$(this).find('[name="username"]').val(),
			el=oprtBtnProp[$(this).find('[name="oprt"]').val()],
			formData=new FormData($(this)[0]),
			<!-- formData=$(this).sierilize(), -->
			strHtml='<p class="text-center" style="font-size:16px;">对用户：<strong>'+name+'</strong></p><p class="text-center" style="font-size:16px;">进行【<span class="'+el.color.txt+'">'+el.glyCom+el.chi+'</span>】</p>';
		//阻止表单提交动作
		evt.preventDefault();
			
		//输入框有效性检查
		inSet.each(function(index){
			let msg=$(this).closest('div').siblings('.spTips').text();
			inputValid($(this),msg);
		});
		
		//formData对象数据整理
		formData.set('dept',$(this).find('[name="dept"]').children('option:selected').text());
		formData.set('joinedGroup',getJoinedGroupStr());
		//有输入框为空的情况,后续语句不再执行。序号最小的$('.inputCheck').eq(i)获得焦点。
		if (!check.every(val=>{return val == true})){
			let arr=[];
			<!-- //check中存在false,对应的input用“has-error”突出显示。 -->
			check.forEach(function(e,index){
				if(!e){
					arr.push(index);
					inSet.eq(index).closest('.has-feedback').removeClass('has-success has-error').addClass('has-error');
				}
			});
			//未通过验证的序号最小的$('.inputCheck').eq(i)获得焦点
			inSet.eq(Math.min.apply(null, arr)).focus();
			return true;			
		}else{
			$('.modal').modal('hide');
			$.confirm(strHtml,function(e){
				e?ajaxUgoprt(url,formData):$('.modal').modal('show');
			}).ok('确定(Y)').cancel('取消(N)');		
		}
	});
	
	<!-- // 表单重置 -->
	//表单重置时附加的操作
	fm.find('input:reset').click(function(e){	
		e.preventDefault();
		check = Array(check.length).fill(false);
		//本按钮所在form进行reset
		fm[0].reset();
		//根据reset后的form状态，重新设定各项组件
		fm.find('.has-feedback').removeClass('has-success has-error').children('span').hide(); 
		radioBg($('#radioCom'));
		
		<!-- initFm(); -->
		fm.find('input.inputCheck').eq(0).focus();
		<!-- console.log(check); -->
	});
	
<!-- function -->
//输入有效性检查
function inputValid(inObj,txt=''){
	let tVal= inObj.val(),
		tName=inObj.attr('name'),
		inSet=fm.find('.inputCheck'),
		//userName正则表达式，由英文、数字、中文和下划线组成,但不能以数字开头,长度为2到20个字符。unicode编码中的汉字范围:\u2E80-\u9FFF
		regUsername = /^[a-zA-Z_\u2E80-\u9FFF][a-zA-Z0-9_\u2E80-\u9FFF]{1,19}$/,
		//mobile正则表达式，11位数字。必须以1开头。
		regMobile = /^1[0-9]{10}$/;
	//定义检查结果函数
	let checkResult=(obj,msg='')=>{
		let pObj=obj.closest('.has-feedback'),
			inSet=fm.find('.inputCheck')
			index=0;
		//obj在inSet中的序号
		for(var i=0;i<inSet.length;i++){
			if(obj.attr('name')==inSet.eq(i).attr('name')){
				<!-- check[i] = false; -->
				index=i;
				break;
			}
		}

		pObj.removeClass('has-success has-error').children('span').hide();
		if(msg.length){
			//显示校验fail的msg
			pObj.addClass('has-error');
			pObj.find('.spTips').text(msg).show();
    		pObj.find('.spRemove').show();
			check[index]=false;			
		}else{
			//校验success
			pObj.addClass('has-success');
			pObj.find('.spOk').show();
			check[index]=true;
		}
	};
		
	<!-- console.log(); -->
	switch(tName){
		//检查[name="username"]的输入框	
		case 'username':
			if(txt!=''){
				return checkResult(inObj,txt);
			}
			if(regUsername.test(tVal)){
				return checkResult(inObj);	
			}
			if(tVal.length < 2){
				txt=(tVal=='')?'用户名不能为空。':'用户名太短，不能少于2个字符。';
			}else{
				txt='可由英文、数字、中文和下划线组成，但不能以数字开头。';
			}
			return checkResult(inObj,txt);
			break;
		//检查[name="mobile"]的输入框
		case 'mobile':
			if(txt!=''){
				return checkResult(inObj,txt);
			}
			if(regMobile.test(tVal)){
				return checkResult(inObj);	
			}
			if(tVal.length < 11){
				txt=(tVal=='')?'手机号不能为空。':'只有'+tVal.length+'位。手机号是11位数字，必须以1开头。';
			}else{
				txt='已有'+tVal.length+'位，但必须是以1开头的11位数字';
			}
			return checkResult(inObj,txt);			
			break;
		//检查[name="dept"]的输入框
		case 'dept':
			txt=(inObj.find('option:selected').length)?'':'请选择一个部门';
			return checkResult(inObj,txt);
			break;
		//检查[name="joinedGroup"]的输入框
		case 'joinedGroup':
			txt=(inObj.find('option:last').val()==0)?'至少加入一个用户组':'';
			return checkResult(inObj,txt);
			break;
	}
}

function ajaxUgoprt(url,data,cbFn){
	let name=fm.find('[name="username"]').val(),
		el=oprtBtnProp[fm.find('[name="oprt"]').val()];
		
	$.ajax({
		type: 'post',
        url: url,
        data: data,
		timeout:2000,
		<!-- datatype: 'JSON', -->
        contentType: false,// 当有文件要上传时，此项是必须的，否则会导致后台无法识别文件流的起始位置
        processData: false,// 是否序列化data属性，默认true(注意：false时type必须是post)。当使用FormData()，必须设为false，否则jqurey默认将FormData()转换为查询字符串。
		success: function(res){
			let msg=res.result?'<span class="alert-success">&nbsp;'+res.msg+'&nbsp;</span>':'<span class="text-muted">&nbsp;'+res.msg+'&nbsp;</span>',
				strHtml='<p class="text-center" style="font-size:16px;">对用户：<strong>'+name+'</strong></p><p class="text-center" style="font-size:16px;">进行【<span class="'+el.color.txt+'">'+el.glyCom+el.chi+'</span>】<br/>结果：'+msg+'</p>';
			<!-- console.log(res); -->
			if(res.oprt!='_READ'){
				//向$('#pageParam')汇集
				$('#pageParam').data('showId',res.data.id);
				<!-- buildRaChkCom(res.data); -->
				
				//更新表格
				//调用index.html中的loadTplFile()
				loadTplFile();
				$.alert(strHtml);
			}else{
				//调用回调函数处理
				res.result?cbFn(res.msg):cbFn();	
			}			
		},
		error: function(){
			$.alert('与服务器通讯超时，请稍后再试！');
		}
	});	
}
<!--// function -->
});

</script>
